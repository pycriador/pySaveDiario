{% extends "base.html" %}

{% block title %}Compartilhar Oferta - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-title">
      <i class="bi bi-share"></i> Compartilhar Oferta
    </h2>
    <a href="{{ url_for('web.offers') }}" class="btn btn-outline-secondary btn-back">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>

  <!-- Offer Info Card -->
  <div class="card mb-4" style="background: var(--panel-solid); border: 1px solid var(--border-color);">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-tag"></i> InformaÃ§Ãµes da Oferta</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h4 class="mb-3 product-title">{{ offer.product.name if offer.product else 'Sem nome' }}</h4>
          {% if offer.product and offer.product.description %}
          <p class="offer-description mb-3">{{ offer.product.description }}</p>
          {% endif %}
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-shop"></i> Vendedor:</strong> 
                <span class="offer-value">{{ offer.vendor_name or 'N/A' }}</span>
              </p>
              {% if offer.seller %}
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-person-badge"></i> Seller:</strong> 
                <span class="offer-value">{{ offer.seller.name }}</span>
              </p>
              {% endif %}
              {% if offer.category %}
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-folder"></i> Categoria:</strong> 
                <span class="offer-value">{{ offer.category.name }}</span>
              </p>
              {% endif %}
              {% if offer.manufacturer %}
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-building"></i> Fabricante:</strong> 
                <span class="offer-value">{{ offer.manufacturer.name }}</span>
              </p>
              {% endif %}
            </div>
            <div class="col-md-6">
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-currency-dollar"></i> PreÃ§o:</strong> 
                <span class="text-success fs-5">{{ offer.currency|currency_symbol }} {{ "%.2f"|format(offer.price) }}</span>
              </p>
              {% if offer.old_price %}
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-tag"></i> PreÃ§o Antigo:</strong> 
                <span class="text-muted text-decoration-line-through">{{ offer.currency|currency_symbol }} {{ "%.2f"|format(offer.old_price) }}</span>
                {% set discount = ((offer.old_price_value - offer.price_value) / offer.old_price_value * 100)|int %}
                <span class="badge bg-danger ms-2">-{{ discount }}%</span>
              </p>
              {% endif %}
              <p class="mb-2 offer-info-text">
                <strong><i class="bi bi-link-45deg"></i> URL:</strong>
                <a href="{{ offer.offer_url }}" target="_blank" class="text-break offer-link">
                  {{ offer.offer_url[:50] }}...
                </a>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 text-center">
          {% if offer.product and offer.product.image_url %}
          <div class="product-image-container-share">
            <img src="{{ offer.product.image_url }}" 
                 alt="{{ offer.product.name }}" 
                 class="img-fluid rounded product-image-share"
                 loading="lazy">
          </div>
          {% else %}
          <div class="product-image-placeholder-share rounded d-flex align-items-center justify-content-center">
            <i class="bi bi-image fs-1"></i>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Coupons & Template Selection -->
    <div class="col-lg-5">
      
      <!-- Social Network Selection -->
      <div class="card mb-4" style="background: var(--panel-solid); border: 1px solid var(--border-color);">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Rede Social</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            {% for network in social_networks %}
            {% set icon_map = {'whatsapp': 'whatsapp', 'facebook': 'facebook', 'twitter': 'twitter', 'instagram': 'instagram', 'telegram': 'telegram', 'linkedin': 'linkedin', 'tiktok': 'tiktok'} %}
            <button type="button" 
                    class="btn text-start social-btn social-btn-{{ network.network }}" 
                    data-channel="{{ network.network }}"
                    style="background: {{ network.color or '#1877f2' }} !important; color: white !important; border: none !important;">
              <i class="bi bi-{{ icon_map.get(network.network, 'share') }}"></i> {{ network.network.title() }}
            </button>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Coupons Selection -->
      {% if active_coupons %}
      <div class="card mb-4" style="background: var(--panel-solid); border: 1px solid var(--border-color);">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="bi bi-ticket-perforated"></i> Cupons do Vendedor (Opcional)
          </h6>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleAllCoupons(true)">
              <i class="bi bi-check-all"></i> Todos
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllCoupons(false)">
              <i class="bi bi-x"></i> Nenhum
            </button>
          </div>
        </div>
        <div class="card-body">
          <small class="text-muted d-block mb-3">
            <i class="bi bi-info-circle"></i> Cupons disponÃ­veis de <strong>{{ offer.seller.name if offer.seller else offer.vendor_name }}</strong>
          </small>
          <div id="couponsList">
            {% for coupon in active_coupons %}
            <div class="form-check mb-2">
                <input class="form-check-input coupon-checkbox" 
                     type="checkbox" 
                     id="coupon_{{ coupon.id }}"
                     data-coupon-code="{{ coupon.code|e }}"
                     data-coupon-seller="{{ (coupon.seller.name if coupon.seller else 'N/A')|e }}"
                     data-coupon-discount-type="{{ coupon.discount_type or '' }}"
                     data-coupon-discount-value="{{ coupon.discount_value or 0 }}"
                     data-coupon-min-purchase="{{ coupon.min_purchase_value or 0 }}"
                     data-coupon-max-discount-value="{{ coupon.max_discount_value or 0 }}"
                     data-coupon-expires="{{ coupon.expires_at.strftime('%d/%m/%Y') if coupon.expires_at else '' }}"
                     checked>
              <label class="form-check-label" for="coupon_{{ coupon.id }}">
                <code>{{ coupon.code }}</code>
                {% if coupon.seller %}
                <small class="text-muted">- {{ coupon.seller.name }}</small>
                {% endif %}
                {% if coupon.discount_value %}
                <span class="badge bg-success ms-2">
                  {% if coupon.discount_type == 'percentage' %}
                  -{{ coupon.discount_value }}%
                  {% if coupon.max_discount_value %}
                  <small>(mÃ¡x R$ {{ "%.2f"|format(coupon.max_discount_value) }})</small>
                  {% endif %}
                  {% else %}
                  -R$ {{ "%.2f"|format(coupon.discount_value) }}
                  {% endif %}
                </span>
                {% endif %}
              </label>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
      <!-- No coupons available -->
      <div class="alert alert-info mb-4" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>Nenhum cupom disponÃ­vel</strong> para o vendedor 
        <strong>{{ offer.seller.name if offer.seller else offer.vendor_name }}</strong>.
        {% if current_user.role in ['admin', 'editor'] %}
        <br>
        <a href="{{ url_for('web.create_coupon') }}" class="alert-link">Criar novo cupom</a>
        {% endif %}
      </div>
      {% endif %}

      <!-- Template Selection -->
      <div class="card mb-4" style="background: var(--panel-solid); border: 1px solid var(--border-color);">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Template</h6>
        </div>
        <div class="card-body">
          {% if templates %}
          <div class="list-group">
            {% for template in templates %}
            <button type="button" 
                    class="list-group-item list-group-item-action template-btn"
                    data-template-id="{{ template.id }}"
                    data-template-name="{{ template.name|e }}"
                    data-template-body="{{ template.body|e }}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">
                    <i class="bi bi-file-earmark-text-fill"></i>
                    {{ template.name }}
                  </h6>
                  <p class="mb-0 text-muted small">
                    {{ template.description or 'Sem descriÃ§Ã£o' }}
                  </p>
                </div>
                {% if template.social_networks %}
                <span class="badge bg-primary bg-opacity-25">
                  {{ template.social_networks|length }} redes
                </span>
                {% endif %}
              </div>
            </button>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle"></i>
            Nenhum template cadastrado. <a href="{{ url_for('web.create_template') }}">Criar template</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Column: Generated Text -->
    <div class="col-lg-7">
      <div class="card sticky-top" style="background: var(--panel-solid); border: 1px solid var(--border-color); top: 20px;">
        <div class="card-header">
          <h6 class="mb-0 generated-text-header">
            <i class="bi bi-chat-text"></i> Texto Gerado
            <span id="selectedChannel" class="badge bg-secondary ms-2 channel-badge">Selecione uma rede social</span>
          </h6>
        </div>
        <div class="card-body">
          <div id="noSelectionMessage" class="text-center py-5 no-selection-msg">
            <i class="bi bi-arrow-left fs-1"></i>
            <p class="mt-3">
              Selecione uma rede social e um template para gerar o texto
            </p>
          </div>
          
          <div id="generatedTextArea" style="display: none;">
            <!-- Formatting Info Box -->
            <div id="formattingInfo" class="mb-3 p-3" style="display: none; border-left: 4px solid #6366f1; background: transparent; border-radius: 8px; border: 1px solid var(--border-color);">
              <div class="d-flex align-items-start">
                <i class="bi bi-palette fs-5 me-3" style="color: #6366f1;"></i>
                <div style="flex: 1;">
                  <strong style="color: var(--text-primary);">FormataÃ§Ãµes suportadas por esta rede:</strong>
                  <div id="formattingSupportList" class="mt-2" style="font-size: 0.9rem; color: var(--text-secondary);"></div>
                </div>
              </div>
            </div>
            
            <!-- Formatting Toolbar -->
            <div id="formattingToolbar" class="btn-toolbar mb-2 p-2" role="toolbar" style="display: none; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); gap: 5px; flex-wrap: wrap;">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('bold')" title="Negrito">
                  <i class="bi bi-type-bold"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('italic')" title="ItÃ¡lico">
                  <i class="bi bi-type-italic"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('strikethrough')" title="Riscado">
                  <i class="bi bi-type-strikethrough"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('code')" title="CÃ³digo">
                  <i class="bi bi-code-slash"></i>
                </button>
              </div>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('link')" title="Link">
                  <i class="bi bi-link-45deg"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('list')" title="Lista">
                  <i class="bi bi-list-ul"></i>
                </button>
              </div>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="applyFormatting('emoji')" title="Emojis">
                  <i class="bi bi-emoji-smile"></i>
                </button>
              </div>
              <small class="text-muted ms-2 align-self-center" style="font-size: 0.75rem;">
                ğŸ’¡ Selecione o texto e clique no botÃ£o de formataÃ§Ã£o
              </small>
            </div>
            
            <textarea 
              id="generatedText" 
              class="form-control mb-3" 
              rows="15" 
              style="font-family: monospace; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); resize: vertical;"></textarea>
            
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary" onclick="copyGeneratedText()">
                <i class="bi bi-clipboard"></i> Copiar Texto
              </button>
              <button type="button" class="btn btn-success" onclick="saveCustomTemplate(); return false;" id="saveTemplateBtn" style="display: none;">
                <i class="bi bi-save"></i> Salvar Template para Esta Rede
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="resetSelection()">
                <i class="bi bi-arrow-counterclockwise"></i> Gerar Novamente
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Offer data
const offerData = {
  id: {{ offer.id }},
  product_name: {{ (offer.product.name if offer.product else '')|tojson }},
  product_description: {{ (offer.product.description if offer.product and offer.product.description else '')|tojson }},
  price: {{ "%.2f"|format(offer.price) if offer.price else 0 }},
  old_price: {{ "%.2f"|format(offer.old_price) if offer.old_price else 0 }},
  currency: {{ offer.currency|tojson }},
  currency_symbol: {{ (offer.currency|currency_symbol)|tojson }},
  vendor_name: {{ offer.vendor_name|tojson }},
  offer_url: {{ offer.offer_url|tojson }},
  seller: {{ (offer.seller.name if offer.seller else '')|tojson }},
  category: {{ (offer.category.name if offer.category else '')|tojson }},
  manufacturer: {{ (offer.manufacturer.name if offer.manufacturer else '')|tojson }},
  // Installment fields
  installment_count: {{ offer.installment_count if offer.installment_count else 'null' }},
  installment_value: {{ "%.2f"|format(offer.installment_value) if offer.installment_value else 'null' }},
  installment_interest_free: {{ 'true' if offer.installment_interest_free else 'false' }},
  product_image_url: {{ (offer.product.image_url if offer.product and offer.product.image_url else '')|tojson }},
  // User contact information (for global namespaces)
  user_phone: {{ (user.phone if user and user.phone else '')|tojson }},
  user_address: {{ (user.address if user and user.address else '')|tojson }},
  user_website: {{ (user.website if user and user.website else '')|tojson }},
  user_instagram: {{ (user.instagram if user and user.instagram else '')|tojson }},
  user_facebook: {{ (user.facebook if user and user.facebook else '')|tojson }},
  user_twitter: {{ (user.twitter if user and user.twitter else '')|tojson }},
  user_linkedin: {{ (user.linkedin if user and user.linkedin else '')|tojson }},
  user_youtube: {{ (user.youtube if user and user.youtube else '')|tojson }},
  user_tiktok: {{ (user.tiktok if user and user.tiktok else '')|tojson }}
};

// Social network configs (prefix/suffix)
const socialConfigs = {{ social_configs|tojson }};

// Pre-selected channel from URL parameter
const preSelectedChannel = {{ selected_channel|tojson }};

// Current selections
let selectedChannel = null;
let selectedTemplate = null;

/**
 * Convert HTML to formatted text based on social network
 * @param {string} html - HTML content from Quill editor
 * @param {string} network - Social network name (whatsapp, telegram, instagram, etc.)
 * @returns {string} - Formatted text for the specific network
 */
/**
 * Convert HTML formatting from Quill.js editor to social network specific formatting
 * 
 * Supported networks and their formatting:
 * - WhatsApp: *bold*, _italic_, ~strikethrough~, ```code```
 * - Telegram: **bold**, __italic__, ~~strikethrough~~, `code`, [link](url)
 * - Instagram/Facebook/Twitter/TikTok: Plain text (no formatting support)
 * - LinkedIn: Limited support (plain text with structure)
 * 
 * @param {string} html - HTML content from Quill editor
 * @param {string} network - Social network name (whatsapp, telegram, instagram, etc)
 * @returns {string} - Formatted text for the specific network
 */
function htmlToFormattedText(html, network) {
  if (!html) return '';
  
  // Create a temporary div to parse HTML
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;
  
  let text = '';
  
  /**
   * Recursive function to process DOM nodes and apply formatting
   */
  function processNode(node) {
    // Handle text nodes
    if (node.nodeType === Node.TEXT_NODE) {
      return node.textContent;
    }
    
    // Handle element nodes
    if (node.nodeType === Node.ELEMENT_NODE) {
      const tagName = node.tagName.toLowerCase();
      let content = '';
      
      // Process all child nodes recursively
      for (let child of node.childNodes) {
        content += processNode(child);
      }
      
      // Apply formatting based on social network and HTML tag
      const networkLower = network.toLowerCase();
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“± WHATSAPP - Markdown-style formatting
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (networkLower === 'whatsapp') {
        switch (tagName) {
          // Bold: <strong>, <b> â†’ *text*
          case 'strong':
          case 'b':
            return `*${content}*`;
          
          // Italic: <em>, <i> â†’ _text_
          case 'em':
          case 'i':
            return `_${content}_`;
          
          // Strikethrough: <s>, <strike>, <del> â†’ ~text~
          case 's':
          case 'strike':
          case 'del':
            return `~${content}~`;
          
          // Monospace/Code: <code>, <pre> â†’ ```text```
          case 'code':
          case 'pre':
            return `\`\`\`${content}\`\`\``;
          
          // Underline: convert to *bold* (WhatsApp doesn't support underline)
          case 'u':
            return `*${content}*`;
          
          // Line break
          case 'br':
            return '\n';
          
          // Paragraph
          case 'p':
            return content + '\n\n';
          
          // Headings â†’ bold + uppercase
          case 'h1':
          case 'h2':
          case 'h3':
          case 'h4':
          case 'h5':
          case 'h6':
            return `*${content.toUpperCase()}*\n\n`;
          
          // Lists
          case 'ul':
          case 'ol':
            return '\n' + content;
          
          case 'li':
            return `â€¢ ${content}\n`;
          
          // Blockquote â†’ indent with >
          case 'blockquote':
            return `â ${content.trim()} â\n\n`;
          
          // Links â†’ text (url)
          case 'a':
            const href = node.getAttribute('href');
            return href ? `${content} (${href})` : content;
          
          // Horizontal rule
          case 'hr':
            return '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
          
          default:
            return content;
        }
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¨ TELEGRAM - Markdown v2 formatting
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      else if (networkLower === 'telegram') {
        switch (tagName) {
          // Bold: <strong>, <b> â†’ **text**
          case 'strong':
          case 'b':
            return `**${content}**`;
          
          // Italic: <em>, <i> â†’ __text__
          case 'em':
          case 'i':
            return `__${content}__`;
          
          // Strikethrough: <s>, <strike>, <del> â†’ ~~text~~
          case 's':
          case 'strike':
          case 'del':
            return `~~${content}~~`;
          
          // Underline: <u> â†’ __text__ (Telegram supports with double underscore in some clients)
          case 'u':
            return `__${content}__`;
          
          // Monospace/Code: <code>, <pre> â†’ `text`
          case 'code':
            return `\`${content}\``;
          
          case 'pre':
            return `\`\`\`\n${content}\n\`\`\``;
          
          // Line break
          case 'br':
            return '\n';
          
          // Paragraph
          case 'p':
            return content + '\n\n';
          
          // Headings â†’ bold + uppercase
          case 'h1':
          case 'h2':
          case 'h3':
          case 'h4':
          case 'h5':
          case 'h6':
            return `**${content.toUpperCase()}**\n\n`;
          
          // Lists
          case 'ul':
          case 'ol':
            return '\n' + content;
          
          case 'li':
            return `â€¢ ${content}\n`;
          
          // Blockquote
          case 'blockquote':
            return `> ${content.trim()}\n\n`;
          
          // Links â†’ [text](url)
          case 'a':
            const href = node.getAttribute('href');
            return href ? `[${content}](${href})` : content;
          
          // Horizontal rule
          case 'hr':
            return '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
          
          default:
            return content;
        }
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’¼ LINKEDIN - Plain text with structure (limited formatting)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      else if (networkLower === 'linkedin') {
        switch (tagName) {
          // Line break
          case 'br':
            return '\n';
          
          // Paragraph
          case 'p':
            return content + '\n\n';
          
          // Headings â†’ UPPERCASE
          case 'h1':
          case 'h2':
          case 'h3':
          case 'h4':
          case 'h5':
          case 'h6':
            return `${content.toUpperCase()}\n\n`;
          
          // Lists
          case 'ul':
          case 'ol':
            return '\n' + content;
          
          case 'li':
            return `â€¢ ${content}\n`;
          
          // Blockquote â†’ indent
          case 'blockquote':
            return `"${content.trim()}"\n\n`;
          
          // Links â†’ keep URL visible
          case 'a':
            const href = node.getAttribute('href');
            return href ? `${content}: ${href}` : content;
          
          // Horizontal rule
          case 'hr':
            return '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
          
          // Strip all formatting tags but keep content
          default:
            return content;
        }
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“· INSTAGRAM / ğŸ“˜ FACEBOOK / ğŸ¦ TWITTER / ğŸµ TIKTOK
      // Plain text only - no formatting support
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      else if (['instagram', 'facebook', 'twitter', 'x', 'tiktok'].includes(networkLower)) {
        switch (tagName) {
          // Line break
          case 'br':
            return '\n';
          
          // Paragraph
          case 'p':
            return content + '\n\n';
          
          // Headings â†’ UPPERCASE for emphasis
          case 'h1':
          case 'h2':
          case 'h3':
          case 'h4':
          case 'h5':
          case 'h6':
            return `${content.toUpperCase()}\n\n`;
          
          // Lists
          case 'ul':
          case 'ol':
            return '\n' + content;
          
          case 'li':
            return `â€¢ ${content}\n`;
          
          // Blockquote â†’ quotation marks
          case 'blockquote':
            return `"${content.trim()}"\n\n`;
          
          // Links â†’ show URL
          case 'a':
            const href = node.getAttribute('href');
            return href ? `${content} (${href})` : content;
          
          // Horizontal rule â†’ use symbols
          case 'hr':
            return '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
          
          // Strip all other formatting
          default:
            return content;
        }
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ”§ DEFAULT - Fallback for unknown networks
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      else {
        switch (tagName) {
          case 'br':
            return '\n';
          case 'p':
            return content + '\n\n';
          case 'ul':
          case 'ol':
            return '\n' + content;
          case 'li':
            return `â€¢ ${content}\n`;
          default:
            return content;
        }
      }
    }
    
    return '';
  }
  
  // Process all child nodes
  for (let child of tempDiv.childNodes) {
    text += processNode(child);
  }
  
  // Clean up extra whitespace
  text = text.replace(/\n{3,}/g, '\n\n'); // Max 2 consecutive line breaks
  text = text.replace(/  +/g, ' '); // Remove multiple spaces
  text = text.trim();
  
  return text;
}

// Toggle all coupons
function toggleAllCoupons(checked) {
  const checkboxes = document.querySelectorAll('.coupon-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = checked;
  });
}

// Wait for DOM to load
document.addEventListener('DOMContentLoaded', function() {
  // Social network button click
  document.querySelectorAll('.social-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all
      document.querySelectorAll('.social-btn').forEach(b => b.classList.remove('active'));
      // Add active to clicked
      this.classList.add('active');
      // Store selected channel
      selectedChannel = this.getAttribute('data-channel');
      // Update badge
      document.getElementById('selectedChannel').textContent = this.textContent.trim();
      // Generate text if template is also selected
      if (selectedTemplate) {
        generateText();
      }
    });
  });

  // Template button click
  document.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all
      document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
      // Add active to clicked
      this.classList.add('active');
      // Store selected template
      selectedTemplate = {
        id: this.getAttribute('data-template-id'),
        name: this.getAttribute('data-template-name'),
        body: this.getAttribute('data-template-body')
      };
      // Generate text if channel is also selected
      if (selectedChannel) {
        generateText();
      }
    });
  });
  
  // Auto-select first social network or pre-selected from URL
  const socialButtons = document.querySelectorAll('.social-btn');
  if (socialButtons.length > 0) {
    let buttonToSelect = null;
    
    // Check if there's a pre-selected channel from URL
    if (preSelectedChannel) {
      // Find button matching the channel
      socialButtons.forEach(btn => {
        if (btn.getAttribute('data-channel').toLowerCase() === preSelectedChannel) {
          buttonToSelect = btn;
        }
      });
    }
    
    // If no match from URL or no URL parameter, select first button
    if (!buttonToSelect) {
      buttonToSelect = socialButtons[0];
    }
    
    // Auto-select the button
    if (buttonToSelect) {
      buttonToSelect.classList.add('active');
      selectedChannel = buttonToSelect.getAttribute('data-channel');
      document.getElementById('selectedChannel').textContent = buttonToSelect.textContent.trim();
    }
  }
});

// Generate text
async function generateText() {
  if (!selectedChannel || !selectedTemplate) {
    return;
  }

  // Try to load custom template for this social network
  let templateBody = selectedTemplate.body;
  let isCustomTemplate = false;
  
  try {
    console.log(`ğŸ” Buscando template customizado: template_id=${selectedTemplate.id}, network=${selectedChannel}`);
    
    const response = await fetch(`/template-social-network/${selectedTemplate.id}/${selectedChannel.toLowerCase()}`);
    const result = await response.json();
    
    console.log('ğŸ“¦ Resposta:', result);
    
    if (response.ok && result.found && result.data) {
      templateBody = result.data.custom_body;
      isCustomTemplate = true;
      console.log(`âœ… Template customizado carregado para ${selectedChannel}`);
      
      // Show indicator that custom template is being used
      showToast(`Template personalizado carregado para ${selectedChannel}!`, 'info');
    } else {
      console.log(`â„¹ï¸  Usando template padrÃ£o (sem customizaÃ§Ã£o para ${selectedChannel})`);
      isCustomTemplate = false;
    }
  } catch (error) {
    console.error('âŒ Erro ao buscar template customizado:', error);
    console.log('â„¹ï¸  Usando template padrÃ£o');
    isCustomTemplate = false;
  }

  // Decode HTML entities
  const textarea = document.createElement('textarea');
  textarea.innerHTML = templateBody;
  let text = textarea.value;

  // Replace namespaces with actual values
  text = text.replace(/{product_name}/gi, offerData.product_name || '');
  text = text.replace(/{product}/gi, offerData.product_name || '');
  
  // Convert HTML description to formatted text for the selected network
  const formattedDescription = htmlToFormattedText(offerData.product_description || '', selectedChannel);
  text = text.replace(/{product_description}/gi, formattedDescription);
  text = text.replace(/{description}/gi, formattedDescription);
  text = text.replace(/{descricao}/gi, formattedDescription);
  
  text = text.replace(/{price}/gi, offerData.price || '');
  text = text.replace(/{valor}/gi, offerData.price || '');
  text = text.replace(/{old_price}/gi, offerData.old_price || '');
  text = text.replace(/{preco_antigo}/gi, offerData.old_price || '');
  
  // Calculate discount
  if (offerData.old_price && offerData.price) {
    const oldPrice = parseFloat(offerData.old_price);
    const price = parseFloat(offerData.price);
    if (oldPrice > price) {
      const discount = Math.round(((oldPrice - price) / oldPrice) * 100);
      text = text.replace(/{discount}/gi, discount + '%');
      text = text.replace(/{desconto}/gi, discount + '%');
    } else {
      text = text.replace(/{discount}/gi, '');
      text = text.replace(/{desconto}/gi, '');
    }
  } else {
    text = text.replace(/{discount}/gi, '');
    text = text.replace(/{desconto}/gi, '');
  }
  
  text = text.replace(/{vendor_name}/gi, offerData.vendor_name || '');
  text = text.replace(/{vendor}/gi, offerData.vendor_name || '');
  text = text.replace(/{seller}/gi, offerData.seller || offerData.vendor_name || '');
  text = text.replace(/{seller_name}/gi, offerData.seller || '');
  text = text.replace(/{loja}/gi, offerData.vendor_name || '');
  
  text = text.replace(/{offer_url}/gi, offerData.offer_url || '');
  text = text.replace(/{url}/gi, offerData.offer_url || '');
  text = text.replace(/{link}/gi, offerData.offer_url || '');
  
  text = text.replace(/{category}/gi, offerData.category || '');
  text = text.replace(/{manufacturer}/gi, offerData.manufacturer || '');

  // Replace installment namespaces
  if (offerData.installment_count && offerData.installment_value) {
    // Individual fields
    text = text.replace(/{installment_count}/gi, offerData.installment_count);
    text = text.replace(/{installment_value}/gi, offerData.installment_value);
    text = text.replace(/{installment_interest_free}/gi, offerData.installment_interest_free ? 'sem juros' : 'com juros');
    
    // Full formatted installment text: "5x de R$ 72.00 sem juros"
    const interestText = offerData.installment_interest_free ? 'sem juros' : 'com juros';
    const installmentFull = `${offerData.installment_count}x de ${offerData.currency_symbol} ${offerData.installment_value} ${interestText}`;
    text = text.replace(/{installment_full}/gi, installmentFull);
    text = text.replace(/{parcelamento}/gi, installmentFull);
  } else {
    // If no installment data, remove the namespaces
    text = text.replace(/{installment_count}/gi, '');
    text = text.replace(/{installment_value}/gi, '');
    text = text.replace(/{installment_interest_free}/gi, '');
    text = text.replace(/{installment_full}/gi, '');
    text = text.replace(/{parcelamento}/gi, '');
  }

  // Collect selected coupons with discount info
  const selectedCoupons = [];
  let bestDiscount = 0;
  let bestDiscountedPrice = parseFloat(offerData.price);
  
  document.querySelectorAll('.coupon-checkbox:checked').forEach(checkbox => {
    const code = checkbox.getAttribute('data-coupon-code');
    const seller = checkbox.getAttribute('data-coupon-seller');
    const discountType = checkbox.getAttribute('data-coupon-discount-type');
    const discountValue = parseFloat(checkbox.getAttribute('data-coupon-discount-value')) || 0;
    const minPurchase = parseFloat(checkbox.getAttribute('data-coupon-min-purchase')) || 0;
    const maxDiscountValue = parseFloat(checkbox.getAttribute('data-coupon-max-discount-value')) || 0;
    const expires = checkbox.getAttribute('data-coupon-expires') || '';
    
    selectedCoupons.push({
      code: code,
      seller: seller,
      discountType: discountType,
      discountValue: discountValue,
      minPurchase: minPurchase,
      maxDiscountValue: maxDiscountValue,
      expires: expires
    });
    
    // Calculate discount for this coupon
    if (discountValue > 0) {
      let discountedPrice = parseFloat(offerData.price);
      let discountAmount = 0;
      
      if (discountType === 'percentage') {
        discountAmount = (discountedPrice * discountValue) / 100;
        
        // Apply max discount limit if set
        if (maxDiscountValue > 0) {
          discountAmount = Math.min(discountAmount, maxDiscountValue);
        }
        
        discountedPrice = discountedPrice - discountAmount;
      } else if (discountType === 'fixed') {
        discountAmount = discountValue;
        discountedPrice = Math.max(0, discountedPrice - discountAmount);
      }
      
      // Track best discount
      if (discountedPrice < bestDiscountedPrice) {
        bestDiscountedPrice = discountedPrice;
        bestDiscount = discountValue;
      }
    }
  });

  // Replace {price_with_coupon} namespace with best discounted price
  if (selectedCoupons.length > 0 && bestDiscountedPrice < parseFloat(offerData.price)) {
    text = text.replace(/{price_with_coupon}/gi, bestDiscountedPrice.toFixed(2));
    text = text.replace(/{preco_com_cupom}/gi, bestDiscountedPrice.toFixed(2));
  } else {
    // No discount applied, use original price
    text = text.replace(/{price_with_coupon}/gi, offerData.price);
    text = text.replace(/{preco_com_cupom}/gi, offerData.price);
  }

  // Replace {all_coupons} namespace
  if (selectedCoupons.length > 0) {
    const allCouponsInline = 'CUPONS: ' + selectedCoupons.map(c => c.code).join(', ');
    text = text.replace(/{all_coupons}/gi, allCouponsInline);
    text = text.replace(/{todos_cupons}/gi, allCouponsInline);
    text = text.replace(/{cupons}/gi, allCouponsInline);
    
    // Replace individual coupon namespaces (use first selected coupon)
    const firstCoupon = selectedCoupons[0];
    
    // Coupon code
    text = text.replace(/{coupon_code}/gi, firstCoupon.code);
    text = text.replace(/{code}/gi, firstCoupon.code);
    
    // Coupon seller
    text = text.replace(/{coupon_seller}/gi, firstCoupon.seller);
    
    // Discount type (translate to Portuguese)
    const discountTypeText = firstCoupon.discountType === 'percentage' ? 'Porcentagem (%)' : 'Valor Fixo (R$)';
    text = text.replace(/{coupon_discount_type}/gi, discountTypeText);
    text = text.replace(/{tipo_desconto}/gi, discountTypeText);
    
    // Discount value
    const discountValueFormatted = firstCoupon.discountType === 'percentage' 
      ? `${firstCoupon.discountValue}%` 
      : `R$ ${firstCoupon.discountValue.toFixed(2)}`;
    text = text.replace(/{coupon_discount_value}/gi, discountValueFormatted);
    text = text.replace(/{valor_desconto}/gi, discountValueFormatted);
    
    // Porcentagem (only for percentage type)
    if (firstCoupon.discountType === 'percentage') {
      text = text.replace(/{porcentagem}/gi, `${firstCoupon.discountValue}%`);
      text = text.replace(/{desconto_porcentagem}/gi, `${firstCoupon.discountValue}%`);
      text = text.replace(/{percentual}/gi, `${firstCoupon.discountValue}%`);
    } else {
      text = text.replace(/{porcentagem}/gi, '');
      text = text.replace(/{desconto_porcentagem}/gi, '');
      text = text.replace(/{percentual}/gi, '');
    }
    
    // Valor Fixo (only for fixed type)
    if (firstCoupon.discountType === 'fixed') {
      const fixedValue = `R$ ${firstCoupon.discountValue.toFixed(2)}`;
      text = text.replace(/{desconto_fixo}/gi, fixedValue);
      text = text.replace(/{valor_fixo}/gi, fixedValue);
    } else {
      text = text.replace(/{desconto_fixo}/gi, '');
      text = text.replace(/{valor_fixo}/gi, '');
    }
    
    // Min purchase value
    if (firstCoupon.minPurchase > 0) {
      const minPurchaseFormatted = `R$ ${firstCoupon.minPurchase.toFixed(2)}`;
      text = text.replace(/{min_purchase_value}/gi, minPurchaseFormatted);
      text = text.replace(/{compra_minima}/gi, minPurchaseFormatted);
      text = text.replace(/{valor_minimo}/gi, minPurchaseFormatted);
      text = text.replace(/{valor_minimo_compra}/gi, minPurchaseFormatted);
      text = text.replace(/{minimo}/gi, minPurchaseFormatted);
    } else {
      text = text.replace(/{min_purchase_value}/gi, 'Sem mÃ­nimo');
      text = text.replace(/{compra_minima}/gi, 'Sem mÃ­nimo');
      text = text.replace(/{valor_minimo}/gi, 'Sem mÃ­nimo');
      text = text.replace(/{valor_minimo_compra}/gi, 'Sem mÃ­nimo');
      text = text.replace(/{minimo}/gi, 'Sem mÃ­nimo');
    }
    
    // Max discount value
    if (firstCoupon.maxDiscountValue > 0) {
      const maxDiscountFormatted = `R$ ${firstCoupon.maxDiscountValue.toFixed(2)}`;
      text = text.replace(/{max_discount_value}/gi, maxDiscountFormatted);
      text = text.replace(/{limite_desconto}/gi, maxDiscountFormatted);
      text = text.replace(/{coupon_max_discount}/gi, maxDiscountFormatted);
      text = text.replace(/{limite}/gi, maxDiscountFormatted);
      text = text.replace(/{valor_maximo_desconto}/gi, maxDiscountFormatted);
      text = text.replace(/{maximo}/gi, maxDiscountFormatted);
    } else {
      text = text.replace(/{max_discount_value}/gi, 'Sem limite');
      text = text.replace(/{limite_desconto}/gi, 'Sem limite');
      text = text.replace(/{coupon_max_discount}/gi, 'Sem limite');
      text = text.replace(/{limite}/gi, 'Sem limite');
      text = text.replace(/{valor_maximo_desconto}/gi, 'Sem limite');
      text = text.replace(/{maximo}/gi, 'Sem limite');
    }
    
    // Coupon expires
    if (firstCoupon.expires) {
      text = text.replace(/{coupon_expires}/gi, firstCoupon.expires);
      text = text.replace(/{validade_cupom}/gi, firstCoupon.expires);
      text = text.replace(/{expira_em}/gi, firstCoupon.expires);
    } else {
      text = text.replace(/{coupon_expires}/gi, 'Sem validade');
      text = text.replace(/{validade_cupom}/gi, 'Sem validade');
      text = text.replace(/{expira_em}/gi, 'Sem validade');
    }
  } else {
    // No coupons selected - clear all coupon namespaces
    text = text.replace(/{all_coupons}/gi, '');
    text = text.replace(/{todos_cupons}/gi, '');
    text = text.replace(/{cupons}/gi, '');
    text = text.replace(/{coupon_code}/gi, '');
    text = text.replace(/{code}/gi, '');
    text = text.replace(/{coupon_seller}/gi, '');
    text = text.replace(/{coupon_discount_type}/gi, '');
    text = text.replace(/{tipo_desconto}/gi, '');
    text = text.replace(/{coupon_discount_value}/gi, '');
    text = text.replace(/{valor_desconto}/gi, '');
    text = text.replace(/{porcentagem}/gi, '');
    text = text.replace(/{desconto_porcentagem}/gi, '');
    text = text.replace(/{percentual}/gi, '');
    text = text.replace(/{desconto_fixo}/gi, '');
    text = text.replace(/{valor_fixo}/gi, '');
    text = text.replace(/{min_purchase_value}/gi, '');
    text = text.replace(/{compra_minima}/gi, '');
    text = text.replace(/{valor_minimo}/gi, '');
    text = text.replace(/{valor_minimo_compra}/gi, '');
    text = text.replace(/{minimo}/gi, '');
    text = text.replace(/{max_discount_value}/gi, '');
    text = text.replace(/{limite_desconto}/gi, '');
    text = text.replace(/{coupon_max_discount}/gi, '');
    text = text.replace(/{limite}/gi, '');
    text = text.replace(/{valor_maximo_desconto}/gi, '');
    text = text.replace(/{maximo}/gi, '');
    text = text.replace(/{coupon_expires}/gi, '');
    text = text.replace(/{validade_cupom}/gi, '');
    text = text.replace(/{expira_em}/gi, '');
  }

  // Append coupons list if selected
  if (selectedCoupons.length > 0) {
    text += '\n\nğŸŸï¸ CUPONS DISPONÃVEIS:\n';
    selectedCoupons.forEach(coupon => {
      text += `â€¢ ${coupon.code} - ${coupon.seller}\n`;
    });
  }

  // Replace global user namespaces
  text = text.replace(/{user_phone}/gi, offerData.user_phone || '');
  text = text.replace(/{telefone}/gi, offerData.user_phone || '');
  text = text.replace(/{celular}/gi, offerData.user_phone || '');
  
  text = text.replace(/{user_address}/gi, offerData.user_address || '');
  text = text.replace(/{endereco}/gi, offerData.user_address || '');
  
  text = text.replace(/{user_website}/gi, offerData.user_website || '');
  text = text.replace(/{site}/gi, offerData.user_website || '');
  
  text = text.replace(/{user_instagram}/gi, offerData.user_instagram || '');
  text = text.replace(/{instagram}/gi, offerData.user_instagram || '');
  
  text = text.replace(/{user_facebook}/gi, offerData.user_facebook || '');
  text = text.replace(/{facebook}/gi, offerData.user_facebook || '');
  
  text = text.replace(/{user_twitter}/gi, offerData.user_twitter || '');
  text = text.replace(/{twitter}/gi, offerData.user_twitter || '');
  
  text = text.replace(/{user_linkedin}/gi, offerData.user_linkedin || '');
  text = text.replace(/{linkedin}/gi, offerData.user_linkedin || '');
  
  text = text.replace(/{user_youtube}/gi, offerData.user_youtube || '');
  text = text.replace(/{youtube}/gi, offerData.user_youtube || '');
  
  text = text.replace(/{user_tiktok}/gi, offerData.user_tiktok || '');
  text = text.replace(/{tiktok}/gi, offerData.user_tiktok || '');

  // Apply social network prefix/suffix
  if (socialConfigs[selectedChannel]) {
    const config = socialConfigs[selectedChannel];
    if (config.prefix_text) {
      text = config.prefix_text + '\n\n' + text;
    }
    if (config.suffix_text) {
      text = text + '\n\n' + config.suffix_text;
    }
  }

  // Display generated text
  document.getElementById('noSelectionMessage').style.display = 'none';
  document.getElementById('generatedTextArea').style.display = 'block';
  document.getElementById('generatedText').value = text;
  
  // Show formatting support info and save button
  showFormattingSupport(selectedChannel);
  
  // Update save button text based on whether custom template exists
  const saveBtn = document.getElementById('saveTemplateBtn');
  if (saveBtn) {
    if (isCustomTemplate) {
      saveBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Atualizar Template Salvo';
      saveBtn.className = 'btn btn-warning';
    } else {
      saveBtn.innerHTML = '<i class="bi bi-save"></i> Salvar Template para Esta Rede';
      saveBtn.className = 'btn btn-success';
    }
  }
}

// Show formatting support for selected network
function showFormattingSupport(network) {
  const formattingInfo = document.getElementById('formattingInfo');
  const supportList = document.getElementById('formattingSupportList');
  
  if (!network || !formattingInfo || !supportList) return;
  
  const networkLower = network.toLowerCase();
  let supportedFormats = [];
  
  switch (networkLower) {
    case 'whatsapp':
      supportedFormats = [
        '<span class="badge bg-success me-1">âœ“ Negrito</span> <code>*texto*</code>',
        '<span class="badge bg-success me-1">âœ“ ItÃ¡lico</span> <code>_texto_</code>',
        '<span class="badge bg-success me-1">âœ“ Riscado</span> <code>~texto~</code>',
        '<span class="badge bg-success me-1">âœ“ CÃ³digo</span> <code>```texto```</code>',
        '<span class="badge bg-success me-1">âœ“ Listas</span>',
        '<span class="badge bg-success me-1">âœ“ Links</span>'
      ];
      break;
      
    case 'telegram':
      supportedFormats = [
        '<span class="badge bg-success me-1">âœ“ Negrito</span> <code>**texto**</code>',
        '<span class="badge bg-success me-1">âœ“ ItÃ¡lico</span> <code>__texto__</code>',
        '<span class="badge bg-success me-1">âœ“ Riscado</span> <code>~~texto~~</code>',
        '<span class="badge bg-success me-1">âœ“ CÃ³digo</span> <code>`texto`</code>',
        '<span class="badge bg-success me-1">âœ“ Listas</span>',
        '<span class="badge bg-success me-1">âœ“ Links</span> <code>[texto](url)</code>'
      ];
      break;
      
    case 'linkedin':
      supportedFormats = [
        '<span class="badge bg-warning text-dark me-1">âš  Texto puro</span>',
        '<span class="badge bg-success me-1">âœ“ MaiÃºsculas</span> para tÃ­tulos',
        '<span class="badge bg-success me-1">âœ“ Listas</span>',
        '<span class="badge bg-success me-1">âœ“ Links</span> (URL visÃ­vel)'
      ];
      break;
      
    case 'instagram':
    case 'facebook':
    case 'twitter':
    case 'x':
    case 'tiktok':
      supportedFormats = [
        '<span class="badge bg-warning text-dark me-1">âš  Texto puro</span> (sem formataÃ§Ã£o)',
        '<span class="badge bg-success me-1">âœ“ Emojis</span>',
        '<span class="badge bg-success me-1">âœ“ MaiÃºsculas</span> para destaque',
        '<span class="badge bg-success me-1">âœ“ Listas</span> com bullet points',
        '<span class="badge bg-info me-1">ğŸ’¡ Dica:</span> Use emojis para destaque visual'
      ];
      break;
      
    default:
      supportedFormats = ['<span class="badge bg-secondary">Texto simples</span>'];
  }
  
  supportList.innerHTML = supportedFormats.join('<br>');
  formattingInfo.style.display = 'block';
  
  // Show formatting toolbar
  const toolbar = document.getElementById('formattingToolbar');
  if (toolbar) {
    toolbar.style.display = 'flex';
  }
  
  // Show save button if template is selected
  const saveBtn = document.getElementById('saveTemplateBtn');
  if (saveBtn && selectedTemplate && selectedTemplate.id) {
    saveBtn.style.display = 'block';
  }
}

// Save custom template for specific social network
async function saveCustomTemplate() {
  if (!selectedTemplate || !selectedChannel) {
    showToast('Selecione um template e uma rede social primeiro', 'warning');
    return false;
  }
  
  const generatedText = document.getElementById('generatedText').value;
  if (!generatedText) {
    showToast('Nenhum texto gerado para salvar', 'warning');
    return false;
  }
  
  const payload = {
    template_id: parseInt(selectedTemplate.id),
    social_network: selectedChannel.toLowerCase(),
    custom_body: generatedText
  };
  
  console.log('ğŸ’¾ Salvando template:', payload);
  
  try {
    const response = await fetch('/template-social-network/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    console.log('Response status:', response.status);
    
    // Try to parse JSON
    let result;
    try {
      result = await response.json();
      console.log('Response data:', result);
    } catch (parseError) {
      console.error('Failed to parse JSON:', parseError);
      showToast('Erro: Resposta invÃ¡lida do servidor', 'danger');
      return false;
    }
    
    if (response.ok && result.success) {
      showToast(result.message || `Template salvo para ${selectedChannel}! âœ“`, 'success');
      
      // Update button to "Update" state
      const saveBtn = document.getElementById('saveTemplateBtn');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Atualizar Template Salvo';
        saveBtn.className = 'btn btn-warning';
      }
      return true;
    } else {
      showToast(result.message || 'Erro ao salvar template', 'danger');
      return false;
    }
  } catch (error) {
    console.error('Error saving template:', error);
    showToast('Erro ao salvar template: ' + error.message, 'danger');
    return false;
  }
}

// Apply formatting to selected text
function applyFormatting(type) {
  const textarea = document.getElementById('generatedText');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  
  // For emoji, we don't need selected text - can insert at cursor position
  if (type === 'emoji') {
    showEmojiPicker(start, end, selectedText);
    return;
  }
  
  // For other formatting, we need selected text
  if (!selectedText) {
    showToast('Selecione o texto que deseja formatar', 'warning');
    return;
  }
  
  if (!selectedChannel) {
    showToast('Selecione uma rede social primeiro', 'warning');
    return;
  }
  
  let formattedText = '';
  const network = selectedChannel.toLowerCase();
  
  switch (type) {
    case 'bold':
      if (network === 'whatsapp') {
        formattedText = `*${selectedText}*`;
      } else if (network === 'telegram') {
        formattedText = `**${selectedText}**`;
      } else {
        formattedText = selectedText.toUpperCase();
      }
      break;
      
    case 'italic':
      if (network === 'whatsapp') {
        formattedText = `_${selectedText}_`;
      } else if (network === 'telegram') {
        formattedText = `__${selectedText}__`;
      } else {
        showToast('ItÃ¡lico nÃ£o suportado nesta rede', 'warning');
        return;
      }
      break;
      
    case 'strikethrough':
      if (network === 'whatsapp') {
        formattedText = `~${selectedText}~`;
      } else if (network === 'telegram') {
        formattedText = `~~${selectedText}~~`;
      } else {
        showToast('Riscado nÃ£o suportado nesta rede', 'warning');
        return;
      }
      break;
      
    case 'code':
      if (network === 'whatsapp') {
        formattedText = `\`\`\`${selectedText}\`\`\``;
      } else if (network === 'telegram') {
        formattedText = `\`${selectedText}\``;
      } else {
        showToast('CÃ³digo nÃ£o suportado nesta rede', 'warning');
        return;
      }
      break;
      
    case 'link':
      const url = prompt('Digite a URL:');
      if (!url) return;
      
      if (network === 'telegram') {
        formattedText = `[${selectedText}](${url})`;
      } else if (network === 'whatsapp') {
        formattedText = `${selectedText} (${url})`;
      } else {
        formattedText = `${selectedText} (${url})`;
      }
      break;
      
    case 'list':
      const lines = selectedText.split('\n');
      formattedText = lines.map(line => line.trim() ? `â€¢ ${line.trim()}` : '').join('\n');
      break;
      
    default:
      return;
  }
  
  // Replace selected text with formatted text
  textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
  
  // Set cursor position after formatted text
  textarea.selectionStart = textarea.selectionEnd = start + formattedText.length;
  textarea.focus();
}

// Show emoji picker
function showEmojiPicker(start, end, selectedText) {
  const emojis = {
    'Rostos': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜'],
    'Dinheiro & CelebraÃ§Ã£o': ['ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ’', 'ğŸ†', 'ğŸ', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ€', 'ğŸ¯', 'ğŸ²'],
    'SÃ­mbolos': ['ğŸ”¥', 'â­', 'âœ¨', 'ğŸ’«', 'âš¡', 'ğŸ’¥', 'ğŸ’¯', 'âœ…', 'âŒ', 'âš ï¸', 'ğŸ”´', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ¡', 'ğŸŸ ', 'ğŸŸ£', 'â¬†ï¸', 'â¬‡ï¸', 'â¡ï¸', 'â¬…ï¸'],
    'MÃ£os': ['ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’ª', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘Œ', 'ğŸ¤'],
    'CoraÃ§Ãµes': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’']
  };
  
  let html = '<div style="max-height: 300px; overflow-y: auto;">';
  
  for (const [category, emojiList] of Object.entries(emojis)) {
    html += `<div class="mb-3">`;
    html += `<strong style="color: var(--text-primary); font-size: 0.9rem;">${category}</strong>`;
    html += `<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">`;
    
    emojiList.forEach(emoji => {
      // Escape selectedText to prevent attribute issues
      const escapedText = selectedText.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      html += `<button type="button" class="btn btn-sm btn-outline-secondary emoji-btn" 
                style="font-size: 1.5rem; padding: 5px 10px; border-radius: 8px;" 
                data-emoji="${emoji}" 
                data-start="${start}" 
                data-end="${end}" 
                data-selected="${escapedText}">
                ${emoji}
              </button>`;
    });
    
    html += `</div></div>`;
  }
  
  html += '</div>';
  
  // Create or update modal
  let modal = document.getElementById('emojiPickerModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'emojiPickerModal';
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-emoji-smile"></i> Escolha um Emoji
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="emojiPickerContent">
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('emojiPickerContent').innerHTML = html;
  
  // Add click event listeners to emoji buttons
  document.querySelectorAll('.emoji-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const emoji = this.getAttribute('data-emoji');
      const start = parseInt(this.getAttribute('data-start'));
      const end = parseInt(this.getAttribute('data-end'));
      const escapedText = this.getAttribute('data-selected');
      
      // Decode HTML entities
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = escapedText;
      const selectedText = tempDiv.textContent || tempDiv.innerText || '';
      
      insertEmoji(emoji, start, end, selectedText);
    });
  });
  
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

// Insert emoji at cursor position
// Show emoji picker modal
function showEmojiPicker(start, end, selectedText) {
  const modalId = 'emojiPickerModal';
  let modal = document.getElementById(modalId);
  
  // If modal doesn't exist, create it
  if (!modal) {
    const modalHTML = `
      <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="emojiPickerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="emojiPickerModalLabel">
                <i class="bi bi-emoji-smile"></i> Selecionar Emoji
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="emojiPickerBody">
              <!-- Emojis will be populated here -->
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    modal = document.getElementById(modalId);
  }
  
  // Populate emojis
  const categories = {
    'Sorrisos': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡'],
    'CoraÃ§Ãµes': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’'],
    'Gestos': ['ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'âœ‹', 'ğŸ¤š', 'ğŸ–', 'ğŸ‘‹'],
    'Objetos': ['ğŸ’°', 'ğŸ’µ', 'ğŸ’³', 'ğŸ’', 'ğŸ', 'ğŸ‰', 'ğŸŠ', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'â­', 'ğŸŒŸ'],
    'Diversos': ['ğŸ”¥', 'âš¡', 'ğŸ’¥', 'âœ¨', 'ğŸ’«', 'ğŸ¯', 'ğŸš€', 'ğŸ’¯', 'âœ…', 'âŒ', 'âš ï¸', 'ğŸ””', 'ğŸ“¢']
  };
  
  let html = '';
  for (const [category, emojis] of Object.entries(categories)) {
    html += `<h6 class="mt-3 mb-2">${category}</h6><div class="d-flex flex-wrap gap-2">`;
    emojis.forEach(emoji => {
      const escapedText = selectedText.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      html += `<button type="button" class="btn btn-sm btn-outline-secondary emoji-btn" 
                style="font-size: 1.5rem; padding: 5px 10px; border-radius: 8px;" 
                data-emoji="${emoji}" 
                data-start="${start}" 
                data-end="${end}" 
                data-selected="${escapedText}">
                ${emoji}
              </button>`;
    });
    html += '</div>';
  }
  
  document.getElementById('emojiPickerBody').innerHTML = html;
  
  // Add click event listeners to emoji buttons
  document.querySelectorAll('.emoji-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const emoji = this.getAttribute('data-emoji');
      const start = parseInt(this.getAttribute('data-start'));
      const end = parseInt(this.getAttribute('data-end'));
      const escapedText = this.getAttribute('data-selected');
      
      // Decode HTML entities
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = escapedText;
      const selectedText = tempDiv.textContent || tempDiv.innerText || '';
      
      insertEmoji(emoji, start, end, selectedText);
    });
  });
  
  // Show modal
  const modalInstance = new bootstrap.Modal(modal);
  modalInstance.show();
}

// Insert emoji at cursor position
function insertEmoji(emoji, start, end, selectedText) {
  const textarea = document.getElementById('generatedText');
  
  // Determine what to insert
  let formattedText;
  if (selectedText && selectedText.trim()) {
    // There's selected text - add emoji after it with space
    formattedText = selectedText + ' ' + emoji;
  } else {
    // No selected text - just insert emoji at cursor position
    formattedText = emoji;
  }
  
  // Replace text in textarea
  const before = textarea.value.substring(0, start);
  const after = textarea.value.substring(end);
  textarea.value = before + formattedText + after;
  
  // Position cursor after inserted text
  const newPosition = start + formattedText.length;
  textarea.selectionStart = textarea.selectionEnd = newPosition;
  textarea.focus();
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('emojiPickerModal'));
  if (modal) modal.hide();
  
  // Show success toast
  const message = selectedText ? `Emoji ${emoji} adicionado ao texto!` : `Emoji ${emoji} inserido!`;
  showToast(message, 'success');
}

// Copy generated text
function copyGeneratedText() {
  const textarea = document.getElementById('generatedText');
  textarea.select();
  document.execCommand('copy');
  
  // Show toast notification
  showToast('Texto copiado!', 'success');
}

// Reset selection
function resetSelection() {
  selectedChannel = null;
  selectedTemplate = null;
  
  document.querySelectorAll('.social-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
  
  document.getElementById('noSelectionMessage').style.display = 'block';
  document.getElementById('generatedTextArea').style.display = 'none';
  document.getElementById('selectedChannel').textContent = 'Selecione uma rede social';
  
  // Hide formatting info
  const formattingInfo = document.getElementById('formattingInfo');
  if (formattingInfo) {
    formattingInfo.style.display = 'none';
  }
  
  // Hide formatting toolbar
  const toolbar = document.getElementById('formattingToolbar');
  if (toolbar) {
    toolbar.style.display = 'none';
  }
  
  // Hide save button
  const saveBtn = document.getElementById('saveTemplateBtn');
  if (saveBtn) {
    saveBtn.style.display = 'none';
  }
}

// Toast notification function
function showToast(message, type = 'success') {
  const toastContainer = document.getElementById('toastContainer') || createToastContainer();
  
  const toastEl = document.createElement('div');
  toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
  toastEl.setAttribute('role', 'alert');
  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  toastContainer.appendChild(toastEl);
  const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
  toast.show();
  
  toastEl.addEventListener('hidden.bs.toast', () => {
    toastEl.remove();
  });
}

function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toastContainer';
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}
</script>

<style>
/* ================================
   DARK THEME - COMPREHENSIVE FIX
   ================================ */

/* Global Dark Theme Text Fix */
body[data-theme="dark"],
html[data-theme="dark"] {
  color: #e5e5e5 !important;
}

body[data-theme="dark"] *,
html[data-theme="dark"] * {
  color: inherit;
}

/* Headers - WHITE */
body[data-theme="dark"] h1,
body[data-theme="dark"] h2,
body[data-theme="dark"] h3,
body[data-theme="dark"] h4,
body[data-theme="dark"] h5,
body[data-theme="dark"] h6,
html[data-theme="dark"] h1,
html[data-theme="dark"] h2,
html[data-theme="dark"] h3,
html[data-theme="dark"] h4,
html[data-theme="dark"] h5,
html[data-theme="dark"] h6 {
  color: #ffffff !important;
}

/* Paragraphs - Light Gray */
body[data-theme="dark"] p,
html[data-theme="dark"] p {
  color: #e5e5e5 !important;
}

/* Strong/Bold - WHITE */
body[data-theme="dark"] strong,
body[data-theme="dark"] b,
html[data-theme="dark"] strong,
html[data-theme="dark"] b {
  color: #ffffff !important;
}

/* Spans - Light Gray */
body[data-theme="dark"] span,
html[data-theme="dark"] span {
  color: #e5e5e5 !important;
}

/* Small text - Medium Gray */
body[data-theme="dark"] small,
html[data-theme="dark"] small {
  color: #d1d5db !important;
}

/* Text Muted - Medium Gray */
body[data-theme="dark"] .text-muted,
html[data-theme="dark"] .text-muted {
  color: #9ca3af !important;
}

/* Labels - Light Gray */
body[data-theme="dark"] label,
html[data-theme="dark"] label {
  color: #e5e5e5 !important;
}

/* Links - Blue */
body[data-theme="dark"] a,
html[data-theme="dark"] a {
  color: #60a5fa !important;
}

body[data-theme="dark"] a:hover,
html[data-theme="dark"] a:hover {
  color: #93c5fd !important;
}

/* Code - Yellow */
body[data-theme="dark"] code,
html[data-theme="dark"] code {
  color: #fbbf24 !important;
  background-color: rgba(251, 191, 36, 0.1) !important;
}

/* Cards */
body[data-theme="dark"] .card,
html[data-theme="dark"] .card {
  color: #e5e5e5 !important;
}

body[data-theme="dark"] .card-header,
html[data-theme="dark"] .card-header {
  color: #ffffff !important;
  background-color: var(--panel-solid) !important;
  border-bottom-color: var(--border-color) !important;
}

body[data-theme="dark"] .card-body,
html[data-theme="dark"] .card-body {
  color: #e5e5e5 !important;
}

/* List Group Items */
body[data-theme="dark"] .list-group-item,
html[data-theme="dark"] .list-group-item {
  background-color: var(--panel-solid) !important;
  color: #e5e5e5 !important;
  border-color: var(--border-color) !important;
}

body[data-theme="dark"] .list-group-item h6,
html[data-theme="dark"] .list-group-item h6 {
  color: #ffffff !important;
}

body[data-theme="dark"] .list-group-item p,
html[data-theme="dark"] .list-group-item p {
  color: #9ca3af !important;
}

body[data-theme="dark"] .list-group-item:hover,
html[data-theme="dark"] .list-group-item:hover {
  background-color: rgba(255, 255, 255, 0.05) !important;
  color: #ffffff !important;
}

/* Buttons */
body[data-theme="dark"] .btn,
html[data-theme="dark"] .btn {
  color: #e5e5e5 !important;
}

body[data-theme="dark"] .btn-primary,
html[data-theme="dark"] .btn-primary {
  color: white !important;
  background-color: #3b82f6 !important;
  border-color: #3b82f6 !important;
}

body[data-theme="dark"] .btn-outline-primary,
html[data-theme="dark"] .btn-outline-primary {
  color: #60a5fa !important;
  border-color: #60a5fa !important;
}

body[data-theme="dark"] .btn-outline-primary:hover,
html[data-theme="dark"] .btn-outline-primary:hover {
  color: white !important;
  background-color: #60a5fa !important;
}

body[data-theme="dark"] .btn-outline-secondary,
html[data-theme="dark"] .btn-outline-secondary {
  color: #9ca3af !important;
  border-color: #6b7280 !important;
}

body[data-theme="dark"] .btn-outline-secondary:hover,
html[data-theme="dark"] .btn-outline-secondary:hover {
  color: white !important;
  background-color: #6b7280 !important;
}

/* Badges */
body[data-theme="dark"] .badge,
html[data-theme="dark"] .badge {
  color: white !important;
}

/* Alerts */
body[data-theme="dark"] .alert,
html[data-theme="dark"] .alert {
  color: #e5e5e5 !important;
}

body[data-theme="dark"] .alert-info,
html[data-theme="dark"] .alert-info {
  background-color: rgba(59, 130, 246, 0.1) !important;
  border-color: rgba(59, 130, 246, 0.3) !important;
  color: #e5e5e5 !important;
}

body[data-theme="dark"] .alert-warning,
html[data-theme="dark"] .alert-warning {
  background-color: rgba(245, 158, 11, 0.1) !important;
  border-color: rgba(245, 158, 11, 0.3) !important;
  color: #e5e5e5 !important;
}

/* Form Elements */
body[data-theme="dark"] .form-check-label,
html[data-theme="dark"] .form-check-label {
  color: #e5e5e5 !important;
}

body[data-theme="dark"] .form-check-label small,
html[data-theme="dark"] .form-check-label small {
  color: #9ca3af !important;
}

/* Specific Classes */
body[data-theme="dark"] .offer-info-text,
html[data-theme="dark"] .offer-info-text,
body[data-theme="dark"] .offer-info-text *,
html[data-theme="dark"] .offer-info-text * {
  color: #ffffff !important;
}

body[data-theme="dark"] .offer-value,
html[data-theme="dark"] .offer-value {
  color: #e5e5e5 !important;
}

body[data-theme="dark"] .offer-description,
html[data-theme="dark"] .offer-description {
  color: #d1d5db !important;
}

body[data-theme="dark"] .offer-link,
html[data-theme="dark"] .offer-link {
  color: #60a5fa !important;
}

body[data-theme="dark"] .offer-link:hover,
html[data-theme="dark"] .offer-link:hover {
  color: #93c5fd !important;
}

/* Product info card - ensure all text is white */
body[data-theme="dark"] .card .row p,
html[data-theme="dark"] .card .row p,
body[data-theme="dark"] .card .row strong,
html[data-theme="dark"] .card .row strong,
body[data-theme="dark"] .card .row span,
html[data-theme="dark"] .card .row span,
body[data-theme="dark"] .card h4,
html[data-theme="dark"] .card h4,
body[data-theme="dark"] .card .col-md-6 p,
html[data-theme="dark"] .card .col-md-6 p,
body[data-theme="dark"] .card .col-md-6 strong,
html[data-theme="dark"] .card .col-md-6 strong,
body[data-theme="dark"] .card .col-md-8 h4,
html[data-theme="dark"] .card .col-md-8 h4 {
  color: #ffffff !important;
}

body[data-theme="dark"] .card .row .offer-value,
html[data-theme="dark"] .card .row .offer-value {
  color: #e5e5e5 !important;
}

/* Force white color on all text elements in offer info */
body[data-theme="dark"] .offer-info-text strong,
html[data-theme="dark"] .offer-info-text strong,
body[data-theme="dark"] .offer-info-text i,
html[data-theme="dark"] .offer-info-text i {
  color: #ffffff !important;
}

/* Product title */
body[data-theme="dark"] .product-title,
html[data-theme="dark"] .product-title {
  color: #ffffff !important;
}

body[data-theme="dark"] .page-title,
html[data-theme="dark"] .page-title {
  color: #ffffff !important;
}

body[data-theme="dark"] .generated-text-header,
html[data-theme="dark"] .generated-text-header {
  color: #ffffff !important;
}

body[data-theme="dark"] .channel-badge,
html[data-theme="dark"] .channel-badge {
  color: white !important;
  background-color: #6b7280 !important;
}

body[data-theme="dark"] .no-selection-msg,
html[data-theme="dark"] .no-selection-msg {
  color: #9ca3af !important;
}

body[data-theme="dark"] .no-selection-msg i,
html[data-theme="dark"] .no-selection-msg i {
  color: #6b7280 !important;
}

body[data-theme="dark"] .no-selection-msg p,
html[data-theme="dark"] .no-selection-msg p {
  color: #9ca3af !important;
}

/* Textarea */
#generatedText {
  font-size: 14px;
  line-height: 1.6;
}

body[data-theme="dark"] #generatedText,
html[data-theme="dark"] #generatedText {
  background-color: #1a1a1a !important;
  color: #e5e5e5 !important;
  border-color: #404040 !important;
}

body[data-theme="light"] #generatedText,
html[data-theme="light"] #generatedText {
  background-color: #ffffff !important;
  color: #212529 !important;
  border-color: #dee2e6 !important;
}

/* Formatting Toolbar */
#formattingToolbar {
  display: flex;
  align-items: center;
}

#formattingToolbar .btn {
  transition: all 0.2s ease;
}

#formattingToolbar .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

#formattingToolbar .btn i {
  font-size: 1.1rem;
}

body[data-theme="dark"] #formattingToolbar,
html[data-theme="dark"] #formattingToolbar {
  background-color: #1a1a1a !important;
  border-color: #404040 !important;
}

body[data-theme="light"] #formattingToolbar,
html[data-theme="light"] #formattingToolbar {
  background-color: #f8f9fa !important;
  border-color: #dee2e6 !important;
}

/* Emoji Picker Modal */
#emojiPickerModal .modal-content {
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

#emojiPickerModal .modal-header {
  border-bottom: 1px solid var(--border-color);
}

#emojiPickerModal .modal-title {
  color: var(--text-primary);
}

#emojiPickerModal .btn-close {
  filter: var(--bs-btn-close-filter, invert(1) grayscale(100%) brightness(200%));
}

body[data-theme="dark"] #emojiPickerModal .btn-close,
html[data-theme="dark"] #emojiPickerModal .btn-close {
  filter: invert(1) grayscale(100%) brightness(200%);
}

body[data-theme="light"] #emojiPickerModal .btn-close,
html[data-theme="light"] #emojiPickerModal .btn-close {
  filter: none;
}

.emoji-btn {
  transition: all 0.15s ease;
  border-color: var(--border-color) !important;
}

.emoji-btn:hover {
  transform: scale(1.2);
  background: var(--bs-primary) !important;
  border-color: var(--bs-primary) !important;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
}

/* Social Buttons */
.social-btn {
  color: white !important;
  font-weight: 500;
  transition: all 0.2s ease;
}

body[data-theme="dark"] .social-btn,
html[data-theme="dark"] .social-btn {
  color: white !important;
}

body[data-theme="dark"] .social-btn.active,
html[data-theme="dark"] .social-btn.active {
  color: white !important;
}

/* Template Buttons */
.template-btn {
  text-align: left;
  transition: all 0.2s ease;
}

.template-btn:hover {
  transform: translateX(5px);
}

body[data-theme="dark"] .template-btn.active,
html[data-theme="dark"] .template-btn.active {
  background-color: rgba(59, 130, 246, 0.2) !important;
  color: #60a5fa !important;
  border-color: #60a5fa !important;
}

body[data-theme="dark"] .template-btn.active h6,
html[data-theme="dark"] .template-btn.active h6 {
  color: #ffffff !important;
}

/* Sticky positioning for generated text card */
@media (min-width: 992px) {
  .sticky-top {
    position: sticky !important;
  }
}

/* Override Bootstrap text colors in dark mode */
body[data-theme="dark"] .text-success,
html[data-theme="dark"] .text-success {
  color: #10b981 !important;
}

body[data-theme="dark"] .text-danger,
html[data-theme="dark"] .text-danger {
  color: #ef4444 !important;
}

body[data-theme="dark"] .text-warning,
html[data-theme="dark"] .text-warning {
  color: #f59e0b !important;
}

body[data-theme="dark"] .text-info,
html[data-theme="dark"] .text-info {
  color: #3b82f6 !important;
}

/* Icons */
body[data-theme="dark"] i,
html[data-theme="dark"] i {
  color: inherit !important;
}

body[data-theme="dark"] .bi,
html[data-theme="dark"] .bi {
  color: inherit !important;
}

/* ================================
   PRODUCT IMAGES - SHARE PAGE
   ================================ */

.product-image-container-share {
  width: 100%;
  max-height: 250px;
  overflow: hidden;
  border-radius: 12px;
  background: var(--bg-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.product-image-share {
  width: 100%;
  height: 100%;
  max-height: 250px;
  object-fit: contain;
  padding: 0.5rem;
}

.product-image-placeholder-share {
  width: 100%;
  height: 250px;
  background: var(--bg-secondary);
  border: 2px dashed var(--border-color);
  color: var(--text-muted);
}

body[data-theme="dark"] .product-image-placeholder-share {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.1);
}

body[data-theme="dark"] .product-image-placeholder-share i {
  color: #6b7280 !important;
}
</style>

{% endblock %}

