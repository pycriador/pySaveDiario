{% extends "base.html" %}
{% block title %}Grupos{% endblock %}

{% block content %}
<section>
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <p class="eyebrow">Times e comunidades</p>
      <h1 class="mb-0">Grupos de curadoria</h1>
    </div>
  </div>

  {% if can_manage %}
  <div class="form-card">
    <div class="form-card-header">
      <h2>Novo grupo</h2>
      <p class="muted">Administradores podem criar grupos customizados.</p>
    </div>
    <form method="post" class="row g-3">
      {{ form.hidden_tag() }}
      <div class="col-md-6">
        <label class="form-label" for="{{ form.name.id }}">Nome</label>
        {{ form.name(class="form-control") }}
      </div>
      <div class="col-md-6">
        <label class="form-label" for="{{ form.slug.id }}">Slug</label>
        {{ form.slug(class="form-control", placeholder="Opcional (visitantes, administradores)") }}
      </div>
      <div class="col-12">
        <label class="form-label" for="{{ form.description.id }}">Descrição</label>
        {{ form.description(class="form-control") }}
      </div>
      <div class="col-12 text-end">
        {{ form.submit_group(class="btn btn-primary px-4") }}
      </div>
    </form>
  </div>
  {% endif %}

  <div class="grid two">
    {% for group in groups %}
    <article class="panel group-card">
      <div class="d-flex justify-content-between align-items-start gap-2">
        <div>
          <h3 class="mb-1">{{ group.name }}</h3>
          <p class="muted mb-2">{{ group.description or "Grupo sem descrição" }}</p>
          <small class="text-uppercase text-muted">Slug: {{ group.slug }}</small>
        </div>
        <span class="badge bg-primary bg-opacity-25 text-white">{{ group.members|length }} membros</span>
      </div>

      {% if group.members %}
      <ul class="list-group list-group-flush mt-3">
        {% for member in group.members %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ member.display_name }}</strong>
            <small class="d-block muted">{{ member.email }}</small>
          </div>
          {% if can_manage %}
          <form method="post" class="ms-3">
            {{ member_form.csrf_token }}
            <input type="hidden" name="group_id" value="{{ group.id }}" />
            <input type="hidden" name="user_id" value="{{ member.id }}" />
            <input type="hidden" name="action" value="remove" />
            <button class="btn btn-outline-danger btn-sm">Remover</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="muted mt-3">Nenhum membro associado ainda.</p>
      {% endif %}

      {% if can_manage %}
      <form method="post" class="mt-3">
        {{ member_form.csrf_token }}
        <input type="hidden" name="group_id" value="{{ group.id }}" />
        <input type="hidden" name="action" value="add" />
        <div class="input-group">
          <select class="form-select" name="user_id" required>
            <option value="">Adicionar usuário...</option>
            {% for user in available_users.get(group.id, []) %}
            <option value="{{ user.id }}">{{ user.display_name }} · {{ user.email }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-primary" type="submit">Adicionar</button>
        </div>
      </form>
      {% endif %}
    </article>
    {% else %}
    <p>Nenhum grupo cadastrado.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}

