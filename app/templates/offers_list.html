{% extends "base.html" %}
{% block title %}Ofertas{% endblock %}

{% block content %}
<section>
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <p class="eyebrow"><i class="bi bi-tags-fill"></i> Comparador multi lojistas</p>
      <h1 class="mb-0">Ofertas acompanhadas</h1>
      <p class="muted mb-0">Filtre via URL ou formulário para descobrir preços por vendedor.</p>
    </div>
    {% if can_manage %}
    <a href="{{ url_for('web.create_offer') }}" class="btn btn-primary btn-sm">
      <i class="bi bi-plus-circle-fill"></i> Nova oferta
    </a>
    {% endif %}
  </div>

  <!-- Filtros Dinâmicos -->
  <div class="panel mb-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">
        <i class="bi bi-funnel-fill"></i> Filtros
      </h5>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
        <i class="bi bi-x-circle"></i> Limpar
      </button>
    </div>
    
    <form id="filterForm" class="row g-3" method="get" action="{{ url_for('web.offers') }}">
      <!-- Search -->
      <div class="col-md-6">
        <label class="form-label" for="search">
          <i class="bi bi-search"></i> Busca geral
        </label>
        <input 
          class="form-control" 
          type="text" 
          name="search" 
          id="search" 
          placeholder="Nome, slug ou vendedor..." 
          value="{{ filters.search or '' }}"
          autocomplete="off" />
        <small class="text-muted">
          <i class="bi bi-info-circle"></i> Busca por nome do produto, slug ou vendedor
        </small>
      </div>
      
      <!-- Active Only Checkbox -->
      <div class="col-md-6">
        <label class="form-label d-block">&nbsp;</label>
        <div class="form-check form-switch" style="padding-top: 0.5rem;">
          <input 
            class="form-check-input" 
            type="checkbox" 
            name="active_only" 
            id="active_only" 
            value="true"
            {% if filters.active_only %}checked{% endif %}>
          <label class="form-check-label" for="active_only">
            <i class="bi bi-check-circle"></i> Apenas ofertas ativas (não expiradas)
          </label>
        </div>
      </div>
      
      <!-- Manufacturer -->
      <div class="col-md-3">
        <label class="form-label" for="manufacturer">
          <i class="bi bi-gear-fill"></i> Fabricante
        </label>
        <select class="form-select" name="manufacturer" id="manufacturer">
          <option value="">Todos</option>
          {% for mfr in manufacturers %}
          <option value="{{ mfr.id }}" {% if filters.manufacturer == mfr.id %}selected{% endif %}>
            {{ mfr.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Category -->
      <div class="col-md-3">
        <label class="form-label" for="category">
          <i class="bi bi-tags"></i> Categoria
        </label>
        <select class="form-select" name="category" id="category">
          <option value="">Todas</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}" {% if filters.category == cat.id %}selected{% endif %}>
            {{ cat.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Seller -->
      <div class="col-md-3">
        <label class="form-label" for="seller">
          <i class="bi bi-shop"></i> Vendedor
        </label>
        <select class="form-select" name="seller" id="seller">
          <option value="">Todos</option>
          {% for s in sellers %}
          <option value="{{ s.id }}" {% if filters.seller == s.id %}selected{% endif %}>
            {{ s.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Price Range -->
      <div class="col-md-3">
        <label class="form-label">
          <i class="bi bi-currency-dollar"></i> Faixa de preço
        </label>
        <div class="input-group">
          <input 
            class="form-control" 
            type="number" 
            step="0.01" 
            name="min_price" 
            id="min_price" 
            placeholder="Min" 
            value="{{ filters.min_price or '' }}" />
          <span class="input-group-text">até</span>
          <input 
            class="form-control" 
            type="number" 
            step="0.01" 
            name="max_price" 
            id="max_price" 
            placeholder="Max" 
            value="{{ filters.max_price or '' }}" />
        </div>
      </div>
    </form>
    
    <!-- Results count -->
    <div class="mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
      <p class="mb-0 text-muted">
        <i class="bi bi-check2-circle"></i> 
        <strong>{{ offers|length }}</strong> oferta(s) encontrada(s)
      </p>
    </div>
  </div>

  <!-- Grid de Ofertas -->
  <div class="grid three">
    {% for offer in offers %}
    <article class="panel card elegant-offer-card">
      <!-- Product Image -->
      {% if offer.product and offer.product.image_url %}
      <div class="product-image-container mb-3">
        <img src="{{ offer.product.image_url }}" 
             alt="{{ offer.product.name }}" 
             class="product-image img-fluid rounded"
             loading="lazy">
      </div>
      {% else %}
      <div class="product-image-placeholder mb-3">
        <i class="bi bi-image"></i>
      </div>
      {% endif %}
      
      <!-- Product Title -->
      <h3 class="offer-card-title mb-3">
        {{ offer.product.name if offer.product else 'Oferta' }}
      </h3>
      
      <!-- Price Section -->
      <div class="price-section mb-3">
        {% if offer.old_price %}
        <div class="old-price mb-2">
          <small class="text-muted text-decoration-line-through">
            {{ offer.currency|currency_symbol }} {{ '%.2f'|format(offer.old_price) }}
          </small>
          {% if offer.old_price_value > offer.price_value %}
          <span class="badge bg-danger ms-2">
            -{{ '%.0f'|format(((offer.old_price_value - offer.price_value) / offer.old_price_value * 100)) }}%
          </span>
          {% endif %}
        </div>
        {% endif %}
        <div class="current-price">
          <span class="price-value">{{ offer.currency|currency_symbol }} {{ '%.2f'|format(offer.price_value) }}</span>
        </div>
      </div>
      
      <!-- Vendor Badge -->
      <div class="vendor-badge mb-3" style="background: {{ offer.seller.color if offer.seller else '#6b7280' }}; border: none;">
        <i class="bi bi-shop" style="color: white !important;"></i>
        <strong style="color: white !important;">{{ offer.vendor_name }}</strong>
      </div>
      
      <!-- Description -->
      {% if offer.product and offer.product.description %}
      <p class="offer-description mb-3">
        {{ offer.product.description[:80] }}{% if offer.product.description|length > 80 %}...{% endif %}
      </p>
      {% endif %}
      
      <!-- Divider -->
      <hr class="card-divider my-3">
      
      <!-- Action Buttons -->
      <div class="card-actions">
        <div class="d-flex gap-2 mb-2">
          {% if offer.offer_url %}
          <a href="{{ offer.offer_url }}" 
             target="_blank" 
             rel="noopener noreferrer" 
             class="btn btn-sm btn-primary flex-grow-1">
            <i class="bi bi-box-arrow-up-right"></i> Ver oferta
          </a>
          {% endif %}
          <a href="{{ url_for('web.share_offer', offer_id=offer.id) }}" 
             class="btn btn-sm btn-outline-primary flex-grow-1">
            <i class="bi bi-share"></i> Compartilhar
          </a>
        </div>
        
        {% if can_manage %}
        <div class="d-flex gap-2">
          <a href="{{ url_for('web.edit_offer', offer_id=offer.id) }}" 
             class="btn btn-sm btn-outline-secondary flex-grow-1">
            <i class="bi bi-pencil-square"></i> Editar
          </a>
          <button type="button" 
                  class="btn btn-sm btn-outline-danger" 
                  onclick="confirmDelete({{ offer.id }}, '{{ offer.product.name if offer.product else 'Oferta' }}', 'offer')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        {% endif %}
      </div>
    </article>
    {% else %}
    <div class="col-12">
      <div class="panel text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-muted);"></i>
        <p class="mt-3 muted">Nenhuma oferta encontrada para esse filtro.</p>
      </div>
    </div>
    {% endfor %}
  </div>
</section>



<!-- Modal: Confirmar Deleção -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill"></i> Confirmar Exclusão
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="text-center py-3">
          <i class="bi bi-trash text-danger" style="font-size: 4rem;"></i>
          <h5 class="mt-3 mb-3">Tem certeza que deseja deletar?</h5>
          <div class="alert alert-warning d-flex align-items-start gap-2">
            <i class="bi bi-exclamation-triangle-fill fs-5"></i>
            <div class="text-start">
              <strong id="deleteItemName" class="text-break"></strong>
              <p class="mb-0 mt-2">Esta ação não pode ser desfeita.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Sim, deletar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* ===================================
   ELEGANT OFFER CARDS
   =================================== */

/* Card Base */
.elegant-offer-card {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid var(--border-color);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  position: relative;
  overflow: hidden;
}

.elegant-offer-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.elegant-offer-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  border-color: #3b82f6;
}

.elegant-offer-card:hover::before {
  opacity: 1;
}

/* Product Images */
.product-image-container {
  width: 100%;
  height: 220px;
  overflow: hidden;
  border-radius: 12px;
  background: var(--bg-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.product-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.elegant-offer-card:hover .product-image {
  transform: scale(1.08);
}

.product-image-placeholder {
  width: 100%;
  height: 220px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--panel-solid) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-size: 3rem;
  border: 2px dashed var(--border-color);
}

/* Product Title */
.offer-card-title {
  font-size: 1.15rem;
  font-weight: 600;
  line-height: 1.4;
  color: var(--text-primary);
  margin: 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 2.8rem;
}

/* Price Section */
.price-section {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
  padding: 1rem;
  border-radius: 10px;
  border-left: 3px solid #3b82f6;
}

.old-price {
  font-size: 0.85rem;
  opacity: 0.7;
}

.current-price {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.price-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: #10b981;
  line-height: 1;
}

body[data-theme="dark"] .price-value {
  color: #34d399;
}

/* Vendor Badge */
.vendor-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.9rem;
}

/* Description */
.offer-description {
  font-size: 0.9rem;
  color: var(--text-muted);
  line-height: 1.5;
  min-height: 3rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Card Divider */
.card-divider {
  border: none;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border-color), transparent);
  margin: 1rem 0;
  opacity: 0.5;
}

/* Card Actions */
.card-actions {
  margin-top: auto;
}

.card-actions .btn {
  font-weight: 500;
  transition: all 0.2s ease;
}

.card-actions .btn-primary {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  border: none;
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
}

.card-actions .btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

.card-actions .btn-outline-primary {
  border-color: #3b82f6;
  color: #3b82f6;
}

.card-actions .btn-outline-primary:hover {
  background: #3b82f6;
  color: white;
}

.card-actions .btn-outline-secondary {
  border-color: #6b7280;
  color: #6b7280;
}

.card-actions .btn-outline-secondary:hover {
  background: #6b7280;
  color: white;
}

.card-actions .btn-outline-danger {
  border-color: #ef4444;
  color: #ef4444;
}

.card-actions .btn-outline-danger:hover {
  background: #ef4444;
  color: white;
}

/* Badge Styles */
.badge {
  font-weight: 600;
  padding: 0.35rem 0.65rem;
  border-radius: 6px;
}

/* Share buttons */
.btn-share {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  padding: 0;
  border: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  color: white;
}

.btn-share:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  color: white;
}

.btn-share i {
  font-size: 1.1rem;
}

.btn-instagram {
  background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
}

.btn-facebook {
  background: #1877f2;
}

.btn-whatsapp {
  background: #25d366;
}

.btn-telegram {
  background: #0088cc;
}

.template-select-btn {
  cursor: pointer;
  transition: all 0.2s ease;
}

.template-select-btn:hover {
  background-color: var(--bs-primary);
  color: white;
  border-color: var(--bs-primary);
}

.template-select-btn:hover .text-muted {
  color: rgba(255,255,255,0.8) !important;
}
</style>

<script>
let currentOfferData = {};

// Social network configurations
const socialNetworkConfigs = {
  {% if social_configs %}
  {% for config in social_configs %}
  '{{ config.network }}': {
    prefix: {{ (config.prefix_text or '')|tojson }},
    suffix: {{ (config.suffix_text or '')|tojson }}
  }{{ ',' if not loop.last else '' }}
  {% endfor %}
  {% endif %}
};

// Confirm delete function for offers
function confirmDelete(id, name, type) {
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  const deleteForm = document.getElementById('deleteForm');
  const deleteItemName = document.getElementById('deleteItemName');
  
  // Set item name
  deleteItemName.textContent = name;
  
  // Set form action based on type
  if (type === 'template') {
    deleteForm.action = `/templates/${id}/delete`;
  } else if (type === 'offer') {
    deleteForm.action = `/ofertas/${id}/delete`;
  }
  
  // Show modal
  modal.show();
}

// Dynamic filter functionality
let filterTimeout;

function updateFilters() {
  clearTimeout(filterTimeout);
  filterTimeout = setTimeout(() => {
    applyFilters();
  }, 500); // 500ms delay after user stops typing
}

function applyFilters() {
  const form = document.getElementById('filterForm');
  const formData = new FormData(form);
  const params = new URLSearchParams();
  
  // Build URL parameters
  for (const [key, value] of formData.entries()) {
    if (value && value.trim() !== '') {
      params.append(key, value);
    }
  }
  
  // Handle checkbox separately (only add if checked)
  const activeOnly = document.getElementById('active_only');
  if (activeOnly.checked) {
    params.set('active_only', 'true');
  } else {
    params.set('active_only', 'false');
  }
  
  // Update URL and reload
  const newUrl = `${window.location.pathname}?${params.toString()}`;
  window.location.href = newUrl;
}

function clearFilters() {
  // Clear all form fields
  document.getElementById('search').value = '';
  document.getElementById('manufacturer').value = '';
  document.getElementById('category').value = '';
  document.getElementById('seller').value = '';
  document.getElementById('min_price').value = '';
  document.getElementById('max_price').value = '';
  document.getElementById('active_only').checked = true; // Default checked
  
  // Reload without parameters (but keep active_only=true)
  window.location.href = `${window.location.pathname}?active_only=true`;
}

// Add event listeners for dynamic filtering
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search');
  const manufacturerSelect = document.getElementById('manufacturer');
  const categorySelect = document.getElementById('category');
  const sellerSelect = document.getElementById('seller');
  const minPriceInput = document.getElementById('min_price');
  const maxPriceInput = document.getElementById('max_price');
  const activeOnlyCheckbox = document.getElementById('active_only');
  
  // Text inputs - update while typing with delay
  searchInput.addEventListener('input', updateFilters);
  minPriceInput.addEventListener('input', updateFilters);
  maxPriceInput.addEventListener('input', updateFilters);
  
  // Selects - update immediately
  manufacturerSelect.addEventListener('change', applyFilters);
  categorySelect.addEventListener('change', applyFilters);
  sellerSelect.addEventListener('change', applyFilters);
  activeOnlyCheckbox.addEventListener('change', applyFilters);
  
  // Prevent form submit (we handle it via JS)
  document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    applyFilters();
  });
});
</script>
{% endblock %}
