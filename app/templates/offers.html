{% extends "base.html" %}
{% block title %}Ofertas{% endblock %}

{% block content %}
<section>
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <p class="eyebrow">Comparador multi lojistas</p>
      <h1 class="mb-0">Ofertas acompanhadas</h1>
      <p class="muted mb-0">Filtre via URL ou formulário para descobrir preços por vendedor.</p>
    </div>
    <form class="d-flex flex-wrap gap-2" method="get">
      <input class="form-control" type="text" name="vendor" placeholder="Vendedor" value="{{ request.args.get('vendor','') }}" />
      <input class="form-control" type="text" name="product" placeholder="Slug do produto" value="{{ request.args.get('product','') }}" />
      <input class="form-control" type="number" step="0.01" name="min_price" placeholder="Preço min" value="{{ request.args.get('min_price','') }}" />
      <input class="form-control" type="number" step="0.01" name="max_price" placeholder="Preço máx" value="{{ request.args.get('max_price','') }}" />
      <button class="btn btn-primary">Filtrar</button>
    </form>
  </div>

  {% if can_manage %}
  <div class="form-card mb-4">
    <div class="form-card-header">
      <div>
        <h2>Nova oferta</h2>
        <p class="muted mb-0">Produtos repetidos podem coexistir com vendedores e preços diferentes.</p>
      </div>
      <button
        class="btn btn-outline-secondary btn-sm"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#offerFormCollapse"
        aria-expanded="false"
      >
        Alternar formulário
      </button>
    </div>
    <div class="collapse show" id="offerFormCollapse">
      <form method="post" class="row g-3 mt-2">
        {{ form.hidden_tag() }}
        <div class="col-md-6">
          <label class="form-label" for="{{ form.product_name.id }}">Nome do produto</label>
          {{ form.product_name(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="{{ form.product_slug.id }}">Slug do produto</label>
          {{ form.product_slug(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="{{ form.vendor_name.id }}">Vendedor</label>
          {{ form.vendor_name(class="form-control") }}
        </div>
        <div class="col-md-3">
          <label class="form-label" for="{{ form.price.id }}">Preço</label>
          {{ form.price(class="form-control") }}
        </div>
        <div class="col-md-3">
          <label class="form-label" for="{{ form.currency.id }}">Moeda</label>
          {{ form.currency(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="{{ form.category.id }}">Categoria</label>
          {{ form.category(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="{{ form.manufacturer.id }}">Fabricante</label>
          {{ form.manufacturer(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="{{ form.offer_url.id }}">URL da oferta</label>
          {{ form.offer_url(class="form-control") }}
        </div>
        <div class="col-md-6">
          <label class="form-label" for="{{ form.expires_at.id }}">Expira em</label>
          {{ form.expires_at(class="form-control", placeholder="2025-12-31T12:00") }}
        </div>
        <div class="col-12">
          <label class="form-label" for="{{ form.product_description.id }}">Descrição do produto</label>
          {{ form.product_description(class="form-control", rows="2") }}
        </div>
        <div class="col-12 text-end">
          {{ form.submit_offer(class="btn btn-primary px-4") }}
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="grid three">
    {% for offer in offers %}
    <article class="panel card">
      <h3>{{ offer.product.name if offer.product else 'Oferta' }}</h3>
      <p>{{ offer.vendor_name }} · {{ offer.currency }} {{ '%.2f'|format(offer.price_value) }}</p>
      <p>{{ offer.product.description if offer.product else "Sem descrição" }}</p>
      {% if offer.offer_url %}
      <a class="btn btn-outline-light btn-sm" href="{{ offer.offer_url }}" target="_blank">Ver detalhes</a>
      {% endif %}
    </article>
    {% else %}
    <p>Nenhuma oferta encontrada para esse filtro.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}

