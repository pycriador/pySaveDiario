{% extends "base.html" %}
{% block title %}Ofertas{% endblock %}

{% block content %}
<section>
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <p class="eyebrow"><i class="bi bi-tags-fill"></i> Comparador multi lojistas</p>
      <h1 class="mb-0">Ofertas acompanhadas</h1>
      <p class="muted mb-0">Filtre via URL ou formulário para descobrir preços por vendedor.</p>
    </div>
    {% if can_manage %}
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createOfferModal">
      <i class="bi bi-plus-circle-fill"></i> Nova oferta
    </button>
    {% endif %}
  </div>

  <!-- Filtros -->
  <div class="form-card mb-4">
    <form class="row g-3" method="get">
      <div class="col-md-3">
        <label class="form-label" for="vendor">
          <i class="bi bi-shop"></i> Vendedor
        </label>
        <input class="form-control" type="text" name="vendor" id="vendor" placeholder="Nome do vendedor" value="{{ request.args.get('vendor','') }}" />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="product">
          <i class="bi bi-box"></i> Slug do produto
        </label>
        <input class="form-control" type="text" name="product" id="product" placeholder="slug-produto" value="{{ request.args.get('product','') }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label" for="min_price">
          <i class="bi bi-currency-dollar"></i> Preço mín
        </label>
        <input class="form-control" type="number" step="0.01" name="min_price" id="min_price" placeholder="0.00" value="{{ request.args.get('min_price','') }}" />
      </div>
      <div class="col-md-2">
        <label class="form-label" for="max_price">
          <i class="bi bi-currency-dollar"></i> Preço máx
        </label>
        <input class="form-control" type="number" step="0.01" name="max_price" id="max_price" placeholder="999.99" value="{{ request.args.get('max_price','') }}" />
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" type="submit">
          <i class="bi bi-search"></i> Filtrar
        </button>
      </div>
    </form>
  </div>

  <!-- Grid de Ofertas -->
  <div class="grid three">
    {% for offer in offers %}
    <article class="panel card">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <h3 style="font-size: 1.25rem;">
          <i class="bi bi-box-seam"></i>
          {{ offer.product.name if offer.product else 'Oferta' }}
        </h3>
      </div>
      
      <div class="price mb-2">
        <i class="bi bi-tag-fill"></i>
        {{ offer.currency }} {{ '%.2f'|format(offer.price_value) }}
      </div>
      
      <p class="mb-2">
        <i class="bi bi-shop"></i>
        <strong>{{ offer.vendor_name }}</strong>
      </p>
      
      <p class="muted" style="font-size: 0.9rem; min-height: 3rem;">
        {{ offer.product.description if offer.product else "Sem descrição" }}
      </p>
      
      {% if offer.offer_url %}
      <a class="btn btn-outline-light btn-sm w-100 mt-2" href="{{ offer.offer_url }}" target="_blank" rel="noopener noreferrer">
        <i class="bi bi-box-arrow-up-right"></i> Ver detalhes
      </a>
      {% endif %}
      
      <!-- Share buttons -->
      <div class="mt-3">
        <small class="text-uppercase text-muted d-block mb-2" style="font-size: 0.7rem; letter-spacing: 0.1em;">
          <i class="bi bi-share-fill"></i> Compartilhar
        </small>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-share btn-instagram share-offer-btn" 
                  data-offer-id="{{ offer.id }}"
                  data-channel="instagram"
                  data-product-name="{{ offer.product.name if offer.product else 'Oferta' }}"
                  data-price="{{ offer.currency }} {{ '%.2f'|format(offer.price_value) }}"
                  data-vendor="{{ offer.vendor_name }}"
                  data-url="{{ offer.offer_url }}">
            <i class="bi bi-instagram"></i>
          </button>
          <button class="btn btn-sm btn-share btn-facebook share-offer-btn" 
                  data-offer-id="{{ offer.id }}"
                  data-channel="facebook"
                  data-product-name="{{ offer.product.name if offer.product else 'Oferta' }}"
                  data-price="{{ offer.currency }} {{ '%.2f'|format(offer.price_value) }}"
                  data-vendor="{{ offer.vendor_name }}"
                  data-url="{{ offer.offer_url }}">
            <i class="bi bi-facebook"></i>
          </button>
          <button class="btn btn-sm btn-share btn-whatsapp share-offer-btn" 
                  data-offer-id="{{ offer.id }}"
                  data-channel="whatsapp"
                  data-product-name="{{ offer.product.name if offer.product else 'Oferta' }}"
                  data-price="{{ offer.currency }} {{ '%.2f'|format(offer.price_value) }}"
                  data-vendor="{{ offer.vendor_name }}"
                  data-url="{{ offer.offer_url }}">
            <i class="bi bi-whatsapp"></i>
          </button>
          <button class="btn btn-sm btn-share btn-telegram share-offer-btn" 
                  data-offer-id="{{ offer.id }}"
                  data-channel="telegram"
                  data-product-name="{{ offer.product.name if offer.product else 'Oferta' }}"
                  data-price="{{ offer.currency }} {{ '%.2f'|format(offer.price_value) }}"
                  data-vendor="{{ offer.vendor_name }}"
                  data-url="{{ offer.offer_url }}">
            <i class="bi bi-telegram"></i>
          </button>
        </div>
      </div>
      
      <!-- Delete button -->
      {% if can_manage %}
      <div class="mt-3 d-flex justify-content-end">
        <button type="button" class="btn btn-sm btn-danger" 
                onclick="confirmDelete({{ offer.id }}, '{{ offer.product.name if offer.product else 'Oferta' }}', 'offer')">
          <i class="bi bi-trash"></i> Deletar
        </button>
      </div>
      {% endif %}
    </article>
    {% else %}
    <div class="col-12">
      <div class="panel text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-muted);"></i>
        <p class="mt-3 muted">Nenhuma oferta encontrada para esse filtro.</p>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Modal: Criar Nova Oferta -->
{% if can_manage %}
<div class="modal fade" id="createOfferModal" tabindex="-1" aria-labelledby="createOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createOfferModalLabel">
          <i class="bi bi-plus-circle-fill"></i> Nova oferta
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="muted mb-3">Produtos repetidos podem coexistir com vendedores e preços diferentes.</p>
        <form method="post" id="createOfferForm" class="row g-3">
          {{ form.hidden_tag() }}
          
          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3" style="font-size: 0.75rem; letter-spacing: 0.1em;">
              <i class="bi bi-box"></i> Informações do Produto
            </h6>
          </div>
          
          <div class="col-md-6">
            <label class="form-label" for="{{ form.product_name.id }}">
              <i class="bi bi-box-seam"></i> Nome do produto
            </label>
            {{ form.product_name(class="form-control", placeholder="Ex: iPhone 15 Pro Max") }}
          </div>
          <div class="col-md-6">
            <label class="form-label" for="{{ form.product_slug.id }}">
              <i class="bi bi-link-45deg"></i> Slug do produto
            </label>
            {{ form.product_slug(class="form-control", placeholder="iphone-15-pro-max") }}
          </div>
          
          <div class="col-12">
            <label class="form-label" for="{{ form.product_description.id }}">
              <i class="bi bi-text-paragraph"></i> Descrição do produto
            </label>
            {{ form.product_description(class="form-control", rows="2", placeholder="Descrição detalhada do produto") }}
          </div>
          
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-tag"></i> Categoria
            </label>
            <div class="input-group">
              {{ form.category_id(class="form-control") }}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCreateCategoryModal">
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-building"></i> Fabricante
            </label>
            <div class="input-group">
              {{ form.manufacturer_id(class="form-control") }}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCreateManufacturerModal">
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>
          </div>
          
          <div class="col-12 mt-4">
            <h6 class="text-uppercase text-muted mb-3" style="font-size: 0.75rem; letter-spacing: 0.1em;">
              <i class="bi bi-shop"></i> Informações da Oferta
            </h6>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-shop"></i> Vendedor
            </label>
            <div class="input-group">
              {{ form.seller_id(class="form-control") }}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCreateSellerModal">
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>
          </div>
          
          <div class="col-md-3">
            <label class="form-label" for="{{ form.price.id }}">
              <i class="bi bi-cash"></i> Preço
            </label>
            {{ form.price(class="form-control", placeholder="0.00") }}
          </div>
          <div class="col-md-3">
            <label class="form-label" for="{{ form.currency.id }}">
              <i class="bi bi-currency-exchange"></i> Moeda
            </label>
            {{ form.currency(class="form-select") }}
          </div>
          
          <div class="col-md-6">
            <label class="form-label" for="{{ form.offer_url.id }}">
              <i class="bi bi-link"></i> URL da oferta
            </label>
            {{ form.offer_url(class="form-control", placeholder="https://...") }}
          </div>
          <div class="col-md-6">
            <label class="form-label" for="{{ form.expires_at.id }}">
              <i class="bi bi-calendar-event"></i> Expira em
            </label>
            <input type="datetime-local" 
                   id="{{ form.expires_at.id }}" 
                   name="{{ form.expires_at.name }}" 
                   class="form-control"
                   step="60">
            <small class="text-muted">
              <i class="bi bi-info-circle"></i>
              Data e hora de expiração da oferta (opcional)
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="submit" form="createOfferForm" class="btn btn-primary">
          <i class="bi bi-check-circle"></i> Criar oferta
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Quick Create Seller -->
<div class="modal fade" id="quickCreateSellerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-shop"></i> Novo Vendedor
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control" id="quickSellerName" placeholder="Ex: Amazon">
        </div>
        <div class="mb-3">
          <label class="form-label">Slug</label>
          <input type="text" class="form-control" id="quickSellerSlug" placeholder="amazon">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="quickCreateSeller()">
          <i class="bi bi-check-circle"></i> Criar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Quick Create Category -->
<div class="modal fade" id="quickCreateCategoryModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-tag"></i> Nova Categoria
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control" id="quickCategoryName" placeholder="Ex: Eletrônicos">
        </div>
        <div class="mb-3">
          <label class="form-label">Slug</label>
          <input type="text" class="form-control" id="quickCategorySlug" placeholder="eletronicos">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="quickCreateCategory()">
          <i class="bi bi-check-circle"></i> Criar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Quick Create Manufacturer -->
<div class="modal fade" id="quickCreateManufacturerModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-building"></i> Novo Fabricante
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control" id="quickManufacturerName" placeholder="Ex: Sony">
        </div>
        <div class="mb-3">
          <label class="form-label">Slug</label>
          <input type="text" class="form-control" id="quickManufacturerSlug" placeholder="sony">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="quickCreateManufacturer()">
          <i class="bi bi-check-circle"></i> Criar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Share Offer -->
<div class="modal fade" id="shareOfferModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shareOfferModalTitle">
          <i class="bi bi-share-fill" id="shareOfferModalIcon"></i>
          <span>Compartilhar</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info d-flex align-items-start gap-2 mb-3">
          <i class="bi bi-lightbulb-fill fs-5"></i>
          <div>
            <strong>Selecione um template:</strong><br>
            <small>Escolha o template que deseja usar para compartilhar esta oferta</small>
          </div>
        </div>
        
        <div class="list-group mb-3" id="templatesList">
          {% for template in templates %}
          <button type="button" 
                  class="list-group-item list-group-item-action template-select-btn"
                  data-template-body="{{ template.body|e }}"
                  onclick="selectTemplate(this)">
            <div class="d-flex w-100 justify-content-between align-items-center">
              <h6 class="mb-1">
                <i class="bi bi-file-text"></i>
                {{ template.name }}
              </h6>
              <i class="bi bi-chevron-right"></i>
            </div>
            {% if template.description %}
            <small class="text-muted">{{ template.description }}</small>
            {% endif %}
          </button>
          {% else %}
          <p class="text-muted text-center py-3">
            <i class="bi bi-info-circle"></i>
            Nenhum template criado ainda.
            <a href="{{ url_for('web.share_templates') }}">Criar template</a>
          </p>
          {% endfor %}
        </div>
        
        <div id="shareTextContainer" style="display: none;">
          <label class="form-label fw-bold">
            <i class="bi bi-clipboard"></i> Texto formatado
          </label>
          <div class="position-relative">
            <textarea id="shareOfferTextArea" class="form-control font-monospace" rows="12" readonly style="resize: none; background: #2d3748; border-color: #4a5568; color: #f7fafc;"></textarea>
            <button class="btn btn-primary btn-sm position-absolute" 
                    style="top: 10px; right: 10px;" 
                    onclick="copyOfferText()"
                    id="copyOfferBtn">
              <i class="bi bi-clipboard"></i> Copiar
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Confirmar Deleção -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill"></i> Confirmar Exclusão
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="text-center py-3">
          <i class="bi bi-trash text-danger" style="font-size: 4rem;"></i>
          <h5 class="mt-3 mb-3">Tem certeza que deseja deletar?</h5>
          <div class="alert alert-warning d-flex align-items-start gap-2">
            <i class="bi bi-exclamation-triangle-fill fs-5"></i>
            <div class="text-start">
              <strong id="deleteItemName" class="text-break"></strong>
              <p class="mb-0 mt-2">Esta ação não pode ser desfeita.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Sim, deletar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<style>
/* Share buttons */
.btn-share {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  padding: 0;
  border: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  color: white;
}

.btn-share:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  color: white;
}

.btn-share i {
  font-size: 1.1rem;
}

.btn-instagram {
  background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
}

.btn-facebook {
  background: #1877f2;
}

.btn-whatsapp {
  background: #25d366;
}

.btn-telegram {
  background: #0088cc;
}

.template-select-btn {
  cursor: pointer;
  transition: all 0.2s ease;
}

.template-select-btn:hover {
  background-color: var(--bs-primary);
  color: white;
  border-color: var(--bs-primary);
}

.template-select-btn:hover .text-muted {
  color: rgba(255,255,255,0.8) !important;
}
</style>

<script>
let currentOfferData = {};

// Helper functions - use toast instead of modals
function showSuccess(message) {
  window.showToast(message, 'success', 5000);
}

function showError(message) {
  window.showToast(message, 'error', 5000);
}

// Quick create functions
async function quickCreateSeller() {
  const name = document.getElementById('quickSellerName').value;
  const slug = document.getElementById('quickSellerSlug').value;
  
  if (!name || !slug) {
    showError('Por favor, preencha nome e slug.');
    return;
  }
  
  const button = event.target;
  const originalHTML = button.innerHTML;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Criando...';
  button.disabled = true;
  
  try {
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    const response = await fetch('/api/sellers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: name,
        slug: slug,
        active: true
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Close modal
      bootstrap.Modal.getInstance(document.getElementById('quickCreateSellerModal')).hide();
      
      // Add new option to dropdown and select it
      const sellerSelect = document.getElementById('{{ form.seller_id.id }}');
      const newOption = new Option(data.name, data.id, true, true);
      sellerSelect.add(newOption);
      
      // Clear form
      document.getElementById('quickSellerName').value = '';
      document.getElementById('quickSellerSlug').value = '';
      
      // Show success toast
      showSuccess(`Vendedor "${data.name}" criado com sucesso!`);
      
      button.innerHTML = originalHTML;
      button.disabled = false;
    } else {
      showError(data.error || 'Erro ao criar vendedor. Verifique os dados.');
      button.innerHTML = originalHTML;
      button.disabled = false;
    }
  } catch (error) {
    console.error('Error:', error);
    showError('Erro ao criar vendedor. Tente novamente.');
    button.innerHTML = originalHTML;
    button.disabled = false;
  }
}

async function quickCreateCategory() {
  const name = document.getElementById('quickCategoryName').value;
  const slug = document.getElementById('quickCategorySlug').value;
  
  if (!name || !slug) {
    showError('Por favor, preencha nome e slug.');
    return;
  }
  
  const button = event.target;
  const originalHTML = button.innerHTML;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Criando...';
  button.disabled = true;
  
  try {
    console.log('Creating category:', { name, slug });
    
    const response = await fetch('/api/categories', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: name,
        slug: slug,
        active: true
      })
    });
    
    console.log('Response status:', response.status);
    
    let data;
    try {
      data = await response.json();
      console.log('Response data:', data);
    } catch (e) {
      console.error('Failed to parse JSON:', e);
      showError('Erro no servidor. Verifique os logs.');
      button.innerHTML = originalHTML;
      button.disabled = false;
      return;
    }
    
    if (response.ok) {
      // Close modal
      bootstrap.Modal.getInstance(document.getElementById('quickCreateCategoryModal')).hide();
      
      // Add new option to dropdown and select it
      const categorySelect = document.getElementById('{{ form.category_id.id }}');
      const newOption = new Option(data.name, data.id, true, true);
      categorySelect.add(newOption);
      
      // Clear form
      document.getElementById('quickCategoryName').value = '';
      document.getElementById('quickCategorySlug').value = '';
      
      // Show success toast
      showSuccess(`Categoria "${data.name}" criada com sucesso!`);
      
      button.innerHTML = originalHTML;
      button.disabled = false;
    } else {
      console.error('API Error:', data);
      showError(data.error || 'Erro ao criar categoria. Verifique os dados.');
      button.innerHTML = originalHTML;
      button.disabled = false;
    }
  } catch (error) {
    console.error('Fetch Error:', error);
    showError(`Erro de conexão: ${error.message}`);
    button.innerHTML = originalHTML;
    button.disabled = false;
  }
}

async function quickCreateManufacturer() {
  const name = document.getElementById('quickManufacturerName').value;
  const slug = document.getElementById('quickManufacturerSlug').value;
  
  if (!name || !slug) {
    showError('Por favor, preencha nome e slug.');
    return;
  }
  
  const button = event.target;
  const originalHTML = button.innerHTML;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Criando...';
  button.disabled = true;
  
  try {
    const response = await fetch('/api/manufacturers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: name,
        slug: slug,
        active: true
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Close modal
      bootstrap.Modal.getInstance(document.getElementById('quickCreateManufacturerModal')).hide();
      
      // Add new option to dropdown and select it
      const manufacturerSelect = document.getElementById('{{ form.manufacturer_id.id }}');
      const newOption = new Option(data.name, data.id, true, true);
      manufacturerSelect.add(newOption);
      
      // Clear form
      document.getElementById('quickManufacturerName').value = '';
      document.getElementById('quickManufacturerSlug').value = '';
      
      // Show success toast
      showSuccess(`Fabricante "${data.name}" criado com sucesso!`);
      
      button.innerHTML = originalHTML;
      button.disabled = false;
    } else {
      showError(data.error || 'Erro ao criar fabricante. Verifique os dados.');
      button.innerHTML = originalHTML;
      button.disabled = false;
    }
  } catch (error) {
    console.error('Error:', error);
    showError('Erro ao criar fabricante. Tente novamente.');
    button.innerHTML = originalHTML;
    button.disabled = false;
  }
}

// Share offer functions
function openShareOfferModal(offerId, channel, productName, price, vendor, url) {
  currentOfferData = {
    offerId,
    channel,
    product_name: productName,
    price,
    vendor_name: vendor,
    offer_url: url
  };
  
  const modal = new bootstrap.Modal(document.getElementById('shareOfferModal'));
  const modalTitle = document.querySelector('#shareOfferModalTitle span');
  const modalIcon = document.getElementById('shareOfferModalIcon');
  
  const networkNames = {
    'instagram': 'Instagram',
    'facebook': 'Facebook',
    'whatsapp': 'WhatsApp',
    'telegram': 'Telegram'
  };
  
  const networkIcons = {
    'instagram': 'bi-instagram',
    'facebook': 'bi-facebook',
    'whatsapp': 'bi-whatsapp',
    'telegram': 'bi-telegram'
  };
  
  modalTitle.textContent = `Compartilhar no ${networkNames[channel]}`;
  modalIcon.className = `bi ${networkIcons[channel]}`;
  
  // Reset
  document.getElementById('shareTextContainer').style.display = 'none';
  
  modal.show();
}

function selectTemplate(button) {
  const templateBody = button.getAttribute('data-template-body');
  
  // Replace namespaces with actual values
  let text = templateBody;
  text = text.replace(/\{product_name\}/g, currentOfferData.product_name);
  text = text.replace(/\{price\}/g, currentOfferData.price);
  text = text.replace(/\{vendor_name\}/g, currentOfferData.vendor_name);
  text = text.replace(/\{offer_url\}/g, currentOfferData.offer_url);
  
  // Show text area
  document.getElementById('shareTextContainer').style.display = 'block';
  document.getElementById('shareOfferTextArea').value = text;
}

function copyOfferText() {
  const textArea = document.getElementById('shareOfferTextArea');
  const copyBtn = document.getElementById('copyOfferBtn');
  
  textArea.select();
  navigator.clipboard.writeText(textArea.value).then(() => {
    const originalHTML = copyBtn.innerHTML;
    copyBtn.innerHTML = '<i class="bi bi-check-lg"></i> Copiado!';
    copyBtn.classList.remove('btn-primary');
    copyBtn.classList.add('btn-success');
    
    setTimeout(() => {
      copyBtn.innerHTML = originalHTML;
      copyBtn.classList.remove('btn-success');
      copyBtn.classList.add('btn-primary');
    }, 2000);
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  const shareButtons = document.querySelectorAll('.share-offer-btn');
  shareButtons.forEach(button => {
    button.addEventListener('click', function() {
      const offerId = this.getAttribute('data-offer-id');
      const channel = this.getAttribute('data-channel');
      const productName = this.getAttribute('data-product-name');
      const price = this.getAttribute('data-price');
      const vendor = this.getAttribute('data-vendor');
      const url = this.getAttribute('data-url');
      
      openShareOfferModal(offerId, channel, productName, price, vendor, url);
    });
  });
  
  // Set default currency when modal opens
  const createOfferModal = document.getElementById('createOfferModal');
  if (createOfferModal) {
    createOfferModal.addEventListener('show.bs.modal', function() {
      const currencySelect = document.getElementById('{{ form.currency.id }}');
      if (currencySelect && !currencySelect.value) {
        currencySelect.value = '{{ default_currency }}';
      }
    });
  }
  
  // Set default time to 00:00 for datetime-local input
  const expiresInput = document.getElementById('{{ form.expires_at.id }}');
  if (expiresInput) {
    expiresInput.addEventListener('change', function() {
      // If user selected a date without time, add 00:00
      if (this.value && this.value.length === 10) {
        this.value = this.value + 'T00:00';
      }
    });
  }
});

// Confirm delete function for offers
function confirmDelete(id, name, type) {
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  const deleteForm = document.getElementById('deleteForm');
  const deleteItemName = document.getElementById('deleteItemName');
  
  // Set item name
  deleteItemName.textContent = name;
  
  // Set form action based on type
  if (type === 'template') {
    deleteForm.action = `/templates/${id}/delete`;
  } else if (type === 'offer') {
    deleteForm.action = `/ofertas/${id}/delete`;
  }
  
  // Show modal
  modal.show();
}
</script>
{% endblock %}
